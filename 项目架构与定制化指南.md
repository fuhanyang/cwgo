# cwgo é¡¹ç›®æ¶æ„ä¸å®šåˆ¶åŒ–å¼€å‘æŒ‡å—

> æœ¬æ–‡æ¡£è¯¦ç»†åˆ†æ cwgo é¡¹ç›®çš„æ¶æ„è®¾è®¡ï¼Œå¹¶æä¾›å®Œæ•´çš„å®šåˆ¶åŒ–å¼€å‘æŒ‡å¯¼ã€‚

## ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#ä¸€é¡¹ç›®æ¦‚è¿°)
2. [æ•´ä½“æ¶æ„](#äºŒæ•´ä½“æ¶æ„)
3. [ä»£ç ç”Ÿæˆæµç¨‹](#ä¸‰ä»£ç ç”Ÿæˆæµç¨‹)
4. [æ ¸å¿ƒæ¨¡å—è¯¦è§£](#å››æ ¸å¿ƒæ¨¡å—è¯¦è§£)
5. [æ¨¡æ¿ç³»ç»Ÿ](#äº”æ¨¡æ¿ç³»ç»Ÿ)
6. [å®šåˆ¶åŒ–å¼€å‘æŒ‡å—](#å…­å®šåˆ¶åŒ–å¼€å‘æŒ‡å—)
7. [å®æˆ˜æ¡ˆä¾‹](#ä¸ƒå®æˆ˜æ¡ˆä¾‹)
8. [å…³é”®æ–‡ä»¶é€ŸæŸ¥è¡¨](#å…«å…³é”®æ–‡ä»¶é€ŸæŸ¥è¡¨)
9. [å¼€å‘å·¥ä½œæµ](#ä¹å¼€å‘å·¥ä½œæµ)
10. [æœ€ä½³å®è·µ](#åæœ€ä½³å®è·µ)
11. [é™„å½•](#åä¸€é™„å½•)
12. [cwgo ä¸ Eino æ¡†æ¶é›†æˆåˆ†æ](#åäºŒcwgo-ä¸-eino-æ¡†æ¶é›†æˆåˆ†æ)

---

## ä¸€ã€é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®å®šä½

cwgo æ˜¯ CloudWeGo ç”Ÿæ€çš„å…¨æ ˆä»£ç ç”Ÿæˆå·¥å…·ï¼Œé›†æˆäº† Kitex (RPC) å’Œ Hertz (HTTP) æ¡†æ¶ï¼Œç”¨äºå¿«é€Ÿç”Ÿæˆå¾®æœåŠ¡è„šæ‰‹æ¶ä»£ç ã€‚

**æ³¨æ„**ï¼šè¯¥é¡¹ç›®å·²å½’æ¡£ï¼Œä¸å†ç»´æŠ¤ï¼Œå»ºè®®åŸºäºæ­¤è¿›è¡Œå®šåˆ¶åŒ–å¼€å‘ã€‚

### 1.2 æ ¸å¿ƒç‰¹æ€§

- **å¤šæ¡†æ¶æ”¯æŒ**ï¼šåŒæ—¶æ”¯æŒ Kitex RPC å’Œ Hertz HTTP
- **é¡¹ç›®æ¨¡æ¿**ï¼šç”Ÿæˆæ ‡å‡†çš„ MVC é¡¹ç›®å¸ƒå±€
- **æ•°æ®åº“é›†æˆ**ï¼šè‡ªåŠ¨ç”Ÿæˆ GORM æ¨¡å‹å’Œ CRUD ä»£ç 
- **å®¢æˆ·ç«¯å°è£…**ï¼šç”Ÿæˆç»Ÿä¸€çš„å®¢æˆ·ç«¯è°ƒç”¨æ¥å£
- **é…ç½®ç®¡ç†**ï¼šæ”¯æŒå¤šç¯å¢ƒé…ç½®æ–‡ä»¶ç”Ÿæˆ
- **æ–‡æ¡£æ•°æ®åº“**ï¼šæ”¯æŒ MongoDB ä»£ç ç”Ÿæˆ

---

## äºŒã€æ•´ä½“æ¶æ„

### 2.1 é¡¹ç›®ç›®å½•ç»“æ„

```
cwgo/
â”œâ”€â”€ cwgo.go                          # ç¨‹åºå…¥å£ï¼Œåˆå§‹åŒ–æ’ä»¶æ¨¡å¼
â”œâ”€â”€ cmd/                             # CLI å‘½ä»¤å®šä¹‰
â”‚   â””â”€â”€ static/                      # é™æ€å‘½ä»¤é…ç½®
â”‚       â”œâ”€â”€ cmd.go                   # å‘½ä»¤è·¯ç”±å™¨ï¼ˆæ ¸å¿ƒï¼‰
â”‚       â”œâ”€â”€ server_flags.go          # server å‘½ä»¤å‚æ•°
â”‚       â”œâ”€â”€ client_flags.go          # client å‘½ä»¤å‚æ•°
â”‚       â”œâ”€â”€ model_flags.go           # model å‘½ä»¤å‚æ•°
â”‚       â”œâ”€â”€ doc_flags.go             # doc å‘½ä»¤å‚æ•°
â”‚       â”œâ”€â”€ job_flags.go             # job å‘½ä»¤å‚æ•°
â”‚       â””â”€â”€ api_list_flags.go        # api_list å‘½ä»¤å‚æ•°
â”œâ”€â”€ config/                          # é…ç½®ç»“æ„ä½“å®šä¹‰
â”‚   â”œâ”€â”€ argument.go                  # é€šç”¨å‚æ•°ç»“æ„
â”‚   â”œâ”€â”€ server.go                    # æœåŠ¡å™¨é…ç½®
â”‚   â”œâ”€â”€ client.go                    # å®¢æˆ·ç«¯é…ç½®
â”‚   â”œâ”€â”€ model.go                     # æ¨¡å‹é…ç½®
â”‚   â”œâ”€â”€ doc.go                       # æ–‡æ¡£é…ç½®
â”‚   â””â”€â”€ job.go                       # ä»»åŠ¡é…ç½®
â”œâ”€â”€ pkg/                             # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ server/                      # æœåŠ¡å™¨ä»£ç ç”Ÿæˆ
â”‚   â”‚   â”œâ”€â”€ server.go                # æœåŠ¡å™¨ç”Ÿæˆå…¥å£
â”‚   â”‚   â”œâ”€â”€ kitex.go                 # Kitex RPC ç”Ÿæˆé€»è¾‘
â”‚   â”‚   â”œâ”€â”€ hz.go                    # Hertz HTTP ç”Ÿæˆé€»è¾‘
â”‚   â”‚   â””â”€â”€ check.go                 # å‚æ•°æ ¡éªŒ
â”‚   â”œâ”€â”€ client/                      # å®¢æˆ·ç«¯ä»£ç ç”Ÿæˆ
â”‚   â”‚   â”œâ”€â”€ client.go                # å®¢æˆ·ç«¯ç”Ÿæˆå…¥å£
â”‚   â”‚   â”œâ”€â”€ kitex.go                 # RPC å®¢æˆ·ç«¯ç”Ÿæˆ
â”‚   â”‚   â””â”€â”€ hz.go                    # HTTP å®¢æˆ·ç«¯ç”Ÿæˆ
â”‚   â”œâ”€â”€ model/                       # æ•°æ®åº“æ¨¡å‹ç”Ÿæˆ
â”‚   â”‚   â”œâ”€â”€ model.go                 # æ¨¡å‹ç”Ÿæˆæ ¸å¿ƒé€»è¾‘
â”‚   â”‚   â””â”€â”€ check.go                 # å‚æ•°æ ¡éªŒ
â”‚   â”œâ”€â”€ config_generator/            # é…ç½®æ–‡ä»¶è½¬ä»£ç 
â”‚   â”‚   â”œâ”€â”€ sdk.go                   # é…ç½®ç”Ÿæˆä¸»é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ yaml2go.go               # YAML è½¬ Go ç»“æ„ä½“
â”‚   â”‚   â””â”€â”€ metadata.go              # å…ƒæ•°æ®å®šä¹‰
â”‚   â”œâ”€â”€ curd/                        # CRUD ä»£ç ç”Ÿæˆ
â”‚   â”‚   â””â”€â”€ doc/                     # MongoDB æ”¯æŒ
â”‚   â”œâ”€â”€ api_list/                    # Hertz è·¯ç”±åˆ†æå·¥å…·
â”‚   â”œâ”€â”€ job/                         # æ‰¹å¤„ç†ä»»åŠ¡ç”Ÿæˆ
â”‚   â”œâ”€â”€ common/                      # é€šç”¨å·¥å…·
â”‚   â”‚   â”œâ”€â”€ utils/                   # å·¥å…·å‡½æ•°
â”‚   â”‚   â””â”€â”€ kx_registry/             # Kitex æ³¨å†Œè¡¨å¤„ç†
â”‚   â””â”€â”€ consts/                      # å¸¸é‡å®šä¹‰
â”œâ”€â”€ tpl/                             # ä»£ç æ¨¡æ¿ï¼ˆæ ¸å¿ƒï¼‰
â”‚   â”œâ”€â”€ init.go                      # æ¨¡æ¿åˆå§‹åŒ–
â”‚   â”œâ”€â”€ kitex/                       # Kitex RPC æ¨¡æ¿
â”‚   â”‚   â”œâ”€â”€ server/                  # æœåŠ¡å™¨ç«¯æ¨¡æ¿
â”‚   â”‚   â”‚   â””â”€â”€ standard/            # æ ‡å‡†å¸ƒå±€
â”‚   â”‚   â”‚       â”œâ”€â”€ main_tpl.yaml    # ä¸»ç¨‹åºå…¥å£
â”‚   â”‚   â”‚       â”œâ”€â”€ handler_tpl.yaml # Handler å®ç°
â”‚   â”‚   â”‚       â”œâ”€â”€ service.yaml     # ä¸šåŠ¡æœåŠ¡å±‚
â”‚   â”‚   â”‚       â”œâ”€â”€ conf_tpl.yaml    # é…ç½®ç»“æ„
â”‚   â”‚   â”‚       â”œâ”€â”€ conf_*_tpl.yaml  # å¤šç¯å¢ƒé…ç½®
â”‚   â”‚   â”‚       â”œâ”€â”€ dal_init.yaml    # DAL åˆå§‹åŒ–
â”‚   â”‚   â”‚       â”œâ”€â”€ kitex_yaml.yaml  # Kitex é…ç½®
â”‚   â”‚   â”‚       â”œâ”€â”€ mysql.yaml       # MySQL é…ç½®
â”‚   â”‚   â”‚       â”œâ”€â”€ redis.yaml       # Redis é…ç½®
â”‚   â”‚   â”‚       â”œâ”€â”€ bootstrap_sh_tpl.yaml  # å¯åŠ¨è„šæœ¬
â”‚   â”‚   â”‚       â”œâ”€â”€ build_sh_tpl.yaml       # æ„å»ºè„šæœ¬
â”‚   â”‚   â”‚       â”œâ”€â”€ docker_compose.yaml     # Docker é…ç½®
â”‚   â”‚   â”‚       â””â”€â”€ readme_tpl.yaml  # é¡¹ç›®æ–‡æ¡£
â”‚   â”‚   â””â”€â”€ client/                  # å®¢æˆ·ç«¯æ¨¡æ¿
â”‚   â”‚       â””â”€â”€ standard/
â”‚   â”‚           â”œâ”€â”€ client_tpl.yaml  # å®¢æˆ·ç«¯æ¥å£
â”‚   â”‚           â”œâ”€â”€ default_tpl.yaml # é»˜è®¤å®ç°
â”‚   â”‚           â””â”€â”€ init_tpl.yaml    # åˆå§‹åŒ–ä»£ç 
â”‚   â””â”€â”€ hertz/                        # Hertz HTTP æ¨¡æ¿
â”‚       â”œâ”€â”€ server/                  # æœåŠ¡å™¨ç«¯æ¨¡æ¿
â”‚       â”‚   â”œâ”€â”€ standard/            # æ ‡å‡†ç‰ˆæœ¬
â”‚       â”‚   â”‚   â”œâ”€â”€ layout.yaml      # é¡¹ç›®å¸ƒå±€
â”‚       â”‚   â”‚   â””â”€â”€ package.yaml     # åŒ…é…ç½®
â”‚       â”‚   â””â”€â”€ standard_v2/         # V2 ç‰ˆæœ¬
â”‚       â””â”€â”€ client/                  # å®¢æˆ·ç«¯æ¨¡æ¿
â”œâ”€â”€ hack/                            # æ„å»ºè„šæœ¬
â”‚   â”œâ”€â”€ tools.sh                     # æµ‹è¯•å’Œæ£€æŸ¥è„šæœ¬
â”‚   â”œâ”€â”€ util.sh                      # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ resolve-modules.sh           # æ¨¡å—è§£æ
â”œâ”€â”€ Makefile                         # æ„å»ºé…ç½®
â””â”€â”€ go.mod                           # Go æ¨¡å—å®šä¹‰
```

### 2.2 æ¶æ„è®¾è®¡åŸåˆ™

1. **æ¨¡å—åŒ–è®¾è®¡**ï¼šå„ç»„ä»¶èŒè´£æ¸…æ™°ï¼Œä½è€¦åˆé«˜å†…èš
2. **æ¨¡æ¿é©±åŠ¨**ï¼šä½¿ç”¨ YAML æ¨¡æ¿çµæ´»æ§åˆ¶ä»£ç ç”Ÿæˆ
3. **æ’ä»¶åŒ–æ¶æ„**ï¼šé€šè¿‡æ’ä»¶æ¨¡å¼ä¸ Kitex/Hz é›†æˆ
4. **é…ç½®åŒ–**ï¼šæ”¯æŒä¸°å¯Œçš„é…ç½®é€‰é¡¹
5. **å¤šæ¡†æ¶æ”¯æŒ**ï¼šç»Ÿä¸€çš„æ¥å£é€‚é…ä¸åŒæ¡†æ¶

---

## ä¸‰ã€ä»£ç ç”Ÿæˆæµç¨‹

### 3.1 æ•´ä½“æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·æ‰§è¡Œå‘½ä»¤                          â”‚
â”‚                    cwgo server -type rpc ...                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CLI å‘½ä»¤è§£æ                              â”‚
â”‚                  cmd/static/cmd.go                           â”‚
â”‚  - è§£æå‘½ä»¤å‚æ•°                                                â”‚
â”‚  - è·¯ç”±åˆ°å¯¹åº”çš„å¤„ç†å‡½æ•°                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‚æ•°éªŒè¯å’Œè½¬æ¢                              â”‚
â”‚                  config/*.go                                 â”‚
â”‚  - éªŒè¯å‚æ•°åˆæ³•æ€§                                              â”‚
â”‚  - è½¬æ¢ä¸ºå†…éƒ¨é…ç½®ç»“æ„                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é€‰æ‹©ç”Ÿæˆç­–ç•¥                                â”‚
â”‚                  pkg/server/server.go                        â”‚
â”‚                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚   â”‚  RPC ç±»å‹     â”‚         â”‚  HTTP ç±»å‹    â”‚                â”‚
â”‚   â”‚  (Kitex)     â”‚         â”‚  (Hertz)     â”‚                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚          â”‚                        â”‚                          â”‚
â”‚          â–¼                        â–¼                          â”‚
â”‚   pkg/server/          pkg/server/hz.go                     â”‚
â”‚   kitex.go                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              è°ƒç”¨åº•å±‚å·¥å…·ï¼ˆKitex/Hzï¼‰                          â”‚
â”‚  - Kitex: è°ƒç”¨ kitex å‘½ä»¤è¡Œå·¥å…·                               â”‚
â”‚  - Hertz: è°ƒç”¨ hz æ’ä»¶æ¨¡å¼                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è¯»å–å¹¶æ¸²æŸ“æ¨¡æ¿                              â”‚
â”‚                  tpl/kitex or tpl/hertz                      â”‚
â”‚  - ä» embed.FS è¯»å–æ¨¡æ¿                                      â”‚
â”‚  - ä½¿ç”¨ Sprig æ¨¡æ¿å‡½æ•°                                       â”‚
â”‚  - æ¸²æŸ“ç”Ÿæˆä»£ç                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åå¤„ç†å’Œæ–‡ä»¶ç”Ÿæˆ                             â”‚
â”‚  - æ›¿æ¢ Thrift ç‰ˆæœ¬                                          â”‚
â”‚  - å‡çº§ Protobuf                                             â”‚
â”‚  - Hessian2 åå¤„ç†                                           â”‚
â”‚  - ç”Ÿæˆæœ€ç»ˆæ–‡ä»¶åˆ°è¾“å‡ºç›®å½•                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 è¯¦ç»†æ‰§è¡Œæµç¨‹

#### Kitex RPC æœåŠ¡ç”Ÿæˆæµç¨‹

```go
// pkg/server/server.go
func Server(c *config.ServerArgument) error {
    // 1. å‚æ•°æ ¡éªŒ
    err = check(c)
    if err != nil {
        return err
    }

    // 2. æ ¹æ® Type é€‰æ‹©ç­–ç•¥
    switch c.Type {
    case consts.RPC:
        // 3. è½¬æ¢ Kitex å‚æ•°
        var args kargs.Arguments
        log.Verbose = c.Verbose
        err = convertKitexArgs(c, &args)

        // 4. å¤„ç†æ³¨å†Œè¡¨
        kx_registry.HandleRegistry(c.CommonParam, args.TemplateDir)
        defer kx_registry.RemoveExtension()

        // 5. æ„å»ºå¹¶æ‰§è¡Œå‘½ä»¤
        out := new(bytes.Buffer)
        cmd := args.BuildCmd(out)
        err = cmd.Run()

        // 6. åå¤„ç†
        utils.ReplaceThriftVersion()
        utils.UpgradeGolangProtobuf()
        utils.Hessian2PostProcessing(args)

    case consts.HTTP:
        // Hertz ç”Ÿæˆæµç¨‹...
    }

    return nil
}
```

#### Hertz HTTP æœåŠ¡ç”Ÿæˆæµç¨‹

```go
// pkg/server/hz.goï¼ˆç®€åŒ–ï¼‰
func convertHzArgument(c *config.ServerArgument, args *hzConfig.Argument) error {
    // 1. åˆ¤æ–­é¡¹ç›®ç±»å‹
    if utils.IsHzNew(c.OutDir) {
        // æ–°é¡¹ç›®ï¼šç”Ÿæˆå®Œæ•´å¸ƒå±€
        args.CmdType = meta.CmdNew
        err = app.GenerateLayout(args)
    } else {
        // å·²å­˜åœ¨é¡¹ç›®ï¼šæ›´æ–°
        args.CmdType = meta.CmdUpdate
        err = manifest.InitAndValidate(args.OutDir)
    }

    // 2. è§¦å‘æ’ä»¶ç”Ÿæˆè·¯ç”±
    err = app.TriggerPlugin(args)

    return nil
}
```

### 3.3 æ¨¡æ¿æ¸²æŸ“æµç¨‹

```go
// tpl/init.go
func Init() {
    // 1. æ¸…ç†ä¸´æ—¶ç›®å½•
    os.RemoveAll(KitexDir)
    os.RemoveAll(HertzDir)

    // 2. åˆ›å»ºä¸´æ—¶ç›®å½•
    os.Mkdir(KitexDir, 0o755)
    os.Mkdir(HertzDir, 0o755)

    // 3. ä» embed.FS æå–æ¨¡æ¿åˆ°ä¸´æ—¶ç›®å½•
    initDir(kitexTpl, consts.Kitex, KitexDir)
    initDir(hertzTpl, consts.Hertz, HertzDir)
}

// æ³¨å†Œæ¨¡æ¿å‡½æ•°ï¼ˆSprig + è‡ªå®šä¹‰ï¼‰
func RegisterTemplateFunc() {
    // 1. æ³¨å†Œ Sprig å‡½æ•°åº“
    for k, f := range sprig.FuncMap() {
        generator.AddTemplateFunc(k, f)
    }

    // 2. æ³¨å†Œè‡ªå®šä¹‰å‡½æ•°
    generator.AddTemplateFunc("ToCamel", func(name string) string {
        name = strings.Replace(name, "_", " ", -1)
        name = strings.Title(name)
        return strings.Replace(name, " ", "", -1)
    })
}
```

---

## å››ã€æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 4.1 æœåŠ¡å™¨ç”Ÿæˆæ¨¡å— (pkg/server)

#### åŠŸèƒ½èŒè´£

- ç”Ÿæˆ Kitex RPC æœåŠ¡ä»£ç 
- ç”Ÿæˆ Hertz HTTP æœåŠ¡ä»£ç 
- æ”¯æŒè‡ªå®šä¹‰æ¨¡æ¿å’Œå¸ƒå±€
- å¤„ç†æ³¨å†Œä¸­å¿ƒå’Œé…ç½®

#### å…³é”®æ–‡ä»¶

| æ–‡ä»¶ | èŒè´£ |
|------|------|
| `server.go` | æœåŠ¡å™¨ç”Ÿæˆçš„ä¸»å…¥å£ï¼Œæ ¹æ®ç±»å‹è·¯ç”±åˆ°ä¸åŒçš„ç”Ÿæˆé€»è¾‘ |
| `kitex.go` | Kitex RPC æœåŠ¡ç”Ÿæˆï¼Œå‚æ•°è½¬æ¢å’Œå‘½ä»¤æ„å»º |
| `hz.go` | Hertz HTTP æœåŠ¡ç”Ÿæˆï¼Œè°ƒç”¨ hz æ’ä»¶ |
| `check.go` | å‚æ•°æ ¡éªŒï¼ŒéªŒè¯ç”¨æˆ·è¾“å…¥çš„åˆæ³•æ€§ |

#### Kitex å‚æ•°è½¬æ¢ç¤ºä¾‹

```go
// pkg/server/kitex.go
func convertKitexArgs(sa *config.ServerArgument, kitexArgument *kargs.Arguments) error {
    // åŸºç¡€å‚æ•°
    kitexArgument.ModuleName = sa.GoMod
    kitexArgument.ServiceName = sa.ServerName
    kitexArgument.IDL = sa.IdlPath

    // Thrift ç¼–è¯‘é€‰é¡¹
    kitexArgument.ThriftOptions = append(kitexArgument.ThriftOptions,
        "naming_style=golint",
        "ignore_initialisms",
        "gen_setter",
        "gen_deep_equal",
        "compatible_names",
        "frugal_tag",
    )

    // æ¨¡æ¿ç›¸å…³
    if sa.Template != "" {
        kitexArgument.TemplateDir = tpl.KitexDir
    }

    return nil
}
```

### 4.2 å®¢æˆ·ç«¯ç”Ÿæˆæ¨¡å— (pkg/client)

#### åŠŸèƒ½èŒè´£

- ç”Ÿæˆç»Ÿä¸€çš„å®¢æˆ·ç«¯è°ƒç”¨æ¥å£
- å°è£… Kitex å’Œ Hertz å®¢æˆ·ç«¯
- æ”¯æŒè¿æ¥æ± å’Œé…ç½®ç®¡ç†
- æä¾›å¼€ç®±å³ç”¨çš„å®¢æˆ·ç«¯

#### ç”Ÿæˆçš„å®¢æˆ·ç«¯ç»“æ„

```
client/
â”œâ”€â”€ rpc_client.go          # RPC å®¢æˆ·ç«¯æ¥å£
â”œâ”€â”€ default_rpc_client.go  # é»˜è®¤å®ç°
â””â”€â”€ init.go                # åˆå§‹åŒ–å‡½æ•°
```

#### å®¢æˆ·ç«¯æ¥å£ç¤ºä¾‹

```go
// ç”Ÿæˆçš„å®¢æˆ·ç«¯æ¥å£
type RPCClient interface {
    // ç”¨æˆ·æœåŠ¡
    UserService() userservice.Client
    // è®¢å•æœåŠ¡
    OrderService() orderservice.Client
}

// é»˜è®¤å®ç°
type DefaultRPCClient struct {
    userService userservice.Client
    orderService orderservice.Client
}

func (c *DefaultRPCClient) UserService() userservice.Client {
    return c.userService
}
```

### 4.3 æ¨¡å‹ç”Ÿæˆæ¨¡å— (pkg/model)

#### åŠŸèƒ½èŒè´£

- ä»æ•°æ®åº“è¡¨ç»“æ„ç”Ÿæˆ GORM æ¨¡å‹
- æ”¯æŒå¤šç§æ•°æ®åº“ï¼ˆMySQL, PostgreSQL, SQLite, SQL Serverï¼‰
- ç”Ÿæˆ CRUD æ–¹æ³•
- æ”¯æŒå•å…ƒæµ‹è¯•ç”Ÿæˆ

#### ç”Ÿæˆæµç¨‹

```go
// pkg/model/model.go
func Model(c *config.ModelArgument) error {
    // 1. è¿æ¥æ•°æ®åº“
    dialector := config.OpenTypeFuncMap[consts.DataBaseType(c.Type)]
    db, err = gorm.Open(dialector(c.DSN))

    // 2. é…ç½®ç”Ÿæˆå™¨
    genConfig := gen.Config{
        OutPath:           c.OutPath,
        OutFile:           c.OutFile,
        ModelPkgPath:      c.ModelPkgName,
        WithUnitTest:      c.WithUnitTest,
        FieldNullable:     c.FieldNullable,
        FieldSignable:     c.FieldSignable,
        FieldWithIndexTag: c.FieldWithIndexTag,
        FieldWithTypeTag:  c.FieldWithTypeTag,
    }

    // 3. åˆ›å»ºç”Ÿæˆå™¨
    g := gen.NewGenerator(genConfig)
    g.UseDB(db)

    // 4. ç”Ÿæˆæ¨¡å‹
    models, err := genModels(g, db, c.Tables)
    if !c.OnlyModel {
        g.ApplyBasic(models...)
    }

    // 5. æ‰§è¡Œç”Ÿæˆ
    g.Execute()

    return nil
}
```

#### ç”Ÿæˆçš„æ¨¡å‹ç¤ºä¾‹

```go
// ç”Ÿæˆçš„æ¨¡å‹
type User struct {
    ID        uint   `gorm:"column:id;primaryKey;autoIncrement" gormType:"uint"`
    Name      string `gorm:"column:name;type:varchar(255);not null" gormType:"string"`
    Email     string `gorm:"column:email;type:varchar(255);uniqueIndex" gormType:"string"`
    CreatedAt time.Time
    UpdatedAt time.Time
}

func (User) TableName() string {
    return "users"
}

// CRUD æ–¹æ³•
type userQuery struct {
    gen.DO
}

func newUserQuery(db *gorm.DB) *userQuery {
    return &userQuery{gen.DO{db: db}}
}

// æŸ¥è¯¢æ–¹æ³•
func (u *userQuery) WhereByID(id uint) *userQuery {
    return u.Where(u.FieldByID().Eq(id))
}
```

### 4.4 é…ç½®ç”Ÿæˆæ¨¡å— (pkg/config_generator)

#### åŠŸèƒ½èŒè´£

- å°† YAML/JSON é…ç½®æ–‡ä»¶è½¬æ¢ä¸º Go ç»“æ„ä½“
- è‡ªåŠ¨è¯†åˆ«æ•°æ®ç±»å‹
- ç”ŸæˆåµŒå¥—ç»“æ„
- æ·»åŠ  JSON/YAML æ ‡ç­¾

#### YAML è½¬ Go ç¤ºä¾‹

è¾“å…¥é…ç½®ï¼š
```yaml
server:
  host: "localhost"
  port: 8080
database:
  type: "mysql"
  connection:
    host: "127.0.0.1"
    port: 3306
```

ç”Ÿæˆä»£ç ï¼š
```go
type Config struct {
    Server     ServerConfig     `yaml:"server"`
    Database   DatabaseConfig   `yaml:"database"`
}

type ServerConfig struct {
    Host string `yaml:"host"`
    Port int    `yaml:"port"`
}

type DatabaseConfig struct {
    Type       string             `yaml:"type"`
    Connection ConnectionConfig   `yaml:"connection"`
}

type ConnectionConfig struct {
    Host string `yaml:"host"`
    Port int    `yaml:"port"`
}
```

---

## äº”ã€æ¨¡æ¿ç³»ç»Ÿ

### 5.1 æ¨¡æ¿ç³»ç»Ÿæ¶æ„

#### æŠ€æœ¯é€‰å‹

- **æ ¼å¼**ï¼šYAML
- **å¼•æ“**ï¼šGo template (text/template)
- **å­˜å‚¨**ï¼šembed.FSï¼ˆå†…åµŒåˆ°äºŒè¿›åˆ¶ï¼‰
- **å‡½æ•°åº“**ï¼šSprig v3 + è‡ªå®šä¹‰å‡½æ•°

#### æ¨¡æ¿æ–‡ä»¶ç»“æ„

```yaml
path: biz/service/{{SnakeString .ServiceName}}/{{ SnakeString (index .Methods 0).Name }}.go
loop_method: true
update_behavior:
  type: skip
delims:
  - "{{"
  - "}}"
body: |-
  // æ¨¡æ¿å†…å®¹
  package {{SnakeString .ServiceName}}

  import (
      "context"
  )

  type {{.Name}}Service struct {
      ctx context.Context
  }
```

#### æ¨¡æ¿å­—æ®µè¯´æ˜

| å­—æ®µ | è¯´æ˜ |
|------|------|
| `path` | è¾“å‡ºæ–‡ä»¶è·¯å¾„ï¼Œæ”¯æŒæ¨¡æ¿å˜é‡ |
| `loop_method` | æ˜¯å¦ä¸ºæ¯ä¸ªæ–¹æ³•ç”Ÿæˆä¸€ä¸ªæ–‡ä»¶ |
| `update_behavior` | æ›´æ–°è¡Œä¸ºï¼ˆskip/cover/appendï¼‰ |
| `delims` | æ¨¡æ¿å®šç•Œç¬¦ï¼ˆå¯é€‰ï¼‰ |
| `body` | æ¨¡æ¿å†…å®¹ |
| `import_tpl` | å¯¼å…¥å…¶ä»–æ¨¡æ¿ï¼ˆå¯é€‰ï¼‰ |

### 5.2 Kitex æ¨¡æ¿è¯¦è§£

#### æœåŠ¡å™¨ç«¯æ¨¡æ¿

| æ–‡ä»¶ | ç”Ÿæˆè·¯å¾„ | è¯´æ˜ |
|------|---------|------|
| `main_tpl.yaml` | `main.go` | ä¸»ç¨‹åºå…¥å£ |
| `handler_tpl.yaml` | `biz/handler/*.go` | Handler å®ç° |
| `service.yaml` | `biz/service/*/*.go` | ä¸šåŠ¡æœåŠ¡å±‚ |
| `conf_tpl.yaml` | `conf/conf.go` | é…ç½®ç»“æ„ |
| `conf_*_tpl.yaml` | `conf/config_*.yaml` | å¤šç¯å¢ƒé…ç½® |
| `dal_init.yaml` | `dal/init.go` | æ•°æ®è®¿é—®å±‚åˆå§‹åŒ– |
| `kitex_yaml.yaml` | `kitex.yaml` | Kitex å·¥å…·é…ç½® |
| `mysql.yaml` | `docker-compose.yml` | MySQL é…ç½® |
| `redis.yaml` | `docker-compose.yml` | Redis é…ç½® |
| `bootstrap_sh_tpl.yaml` | `bootstrap.sh` | å¯åŠ¨è„šæœ¬ |
| `build_sh_tpl.yaml` | `build.sh` | æ„å»ºè„šæœ¬ |
| `docker_compose.yaml` | `docker-compose.yml` | Docker ç¼–æ’ |
| `readme_tpl.yaml` | `README.md` | é¡¹ç›®æ–‡æ¡£ |

#### å®¢æˆ·ç«¯æ¨¡æ¿

| æ–‡ä»¶ | ç”Ÿæˆè·¯å¾„ | è¯´æ˜ |
|------|---------|------|
| `client_tpl.yaml` | `client/rpc_client.go` | å®¢æˆ·ç«¯æ¥å£ |
| `default_tpl.yaml` | `client/default_rpc_client.go` | é»˜è®¤å®ç° |
| `init_tpl.yaml` | `client/init.go` | åˆå§‹åŒ–å‡½æ•° |

### 5.3 Hertz æ¨¡æ¿è¯¦è§£

#### æ ‡å‡†ç‰ˆæœ¬ (standard)

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `layout.yaml` | é¡¹ç›®å¸ƒå±€å®šä¹‰ï¼ŒåŒ…å« main.goã€routerã€handler ç­‰ |
| `package.yaml` | åŒ…ä¿¡æ¯é…ç½® |

#### V2 ç‰ˆæœ¬ (standard_v2)

ä¼˜åŒ–åçš„å¸ƒå±€ï¼Œæä¾›äº†æ›´å¥½çš„ç»„ç»‡ç»“æ„ã€‚

### 5.4 æ¨¡æ¿å˜é‡

#### å¸¸ç”¨æ¨¡æ¿å˜é‡

```go
// æœåŠ¡ç›¸å…³
.ServiceName       // æœåŠ¡åç§°
.Type              // æœåŠ¡ç±»å‹ï¼ˆRPC/HTTPï¼‰
.GoModule          // Go æ¨¡å—å

// æ–¹æ³•ç›¸å…³
.Methods           // æ–¹æ³•åˆ—è¡¨
.Name              // æ–¹æ³•å
.Args              // æ–¹æ³•å‚æ•°
.Resp              // è¿”å›å€¼
.Void              // æ˜¯å¦æ— è¿”å›å€¼
.Oneway            // æ˜¯å¦å•å‘è°ƒç”¨

// IDL ç›¸å…³
.IdlPath           // IDL æ–‡ä»¶è·¯å¾„
.Imports           // å¯¼å…¥åŒ…

// è‡ªå®šä¹‰é…ç½®
.OutDir            // è¾“å‡ºç›®å½•
.Registry          // æ³¨å†Œä¸­å¿ƒç±»å‹
```

#### å¸¸ç”¨æ¨¡æ¿å‡½æ•°

```go
// Sprig å‡½æ•°åº“
{{ toLower "String" }}        // è½¬å°å†™
{{ toUpper "String" }}        // è½¬å¤§å†™
{{ title "String" }}          // é¦–å­—æ¯å¤§å†™
{{ snakeCase "String" }}      // è›‡å½¢å‘½å
{{ camelCase "String" }}      // é©¼å³°å‘½å

// è‡ªå®šä¹‰å‡½æ•°
{{ ToCamel "string" }}        // è½¬é©¼å³°
{{ SnakeString "String" }}    // è½¬è›‡å½¢
{{ LowerFirst "String" }}     // é¦–å­—æ¯å°å†™
```

---

## å…­ã€å®šåˆ¶åŒ–å¼€å‘æŒ‡å—

### 6.1 ä¿®æ”¹ç”Ÿæˆçš„ä»£ç ç»“æ„ï¼ˆæœ€å¸¸è§ï¼‰

#### åœºæ™¯ 1ï¼šä¸ºæœåŠ¡æ·»åŠ ç»Ÿä¸€çš„é”™è¯¯å¤„ç†

**ä¿®æ”¹æ–‡ä»¶**ï¼š`tpl/kitex/server/standard/service.yaml`

```yaml
# åŸå§‹æ¨¡æ¿
body: |-
  func (s *{{.Name}}Service) Run({{range .Args}}{{LowerFirst .Name}} {{.Type}}, {{end}}) (resp {{.Resp.Type}}, err error) {
    // Finish your business logic.
    return
  }

# ä¿®æ”¹åï¼šæ·»åŠ ç»Ÿä¸€é”™è¯¯å¤„ç†
body: |-
  import (
    "context"
    "your-project/pkg/errors"
    "github.com/cloudwego/hertz/pkg/common/hlog"
  )

  func (s *{{.Name}}Service) Run({{range .Args}}{{LowerFirst .Name}} {{.Type}}, {{end}}) (resp {{.Resp.Type}}, err error) {
    // æ·»åŠ  panic æ¢å¤
    defer func() {
      if r := recover(); r != nil {
        err = errors.NewPanicError(r)
        hlog.Errorf("panic in {{.Name}}: %v", r)
      }
    }()

    // æ·»åŠ æ–¹æ³•è¿›å…¥æ—¥å¿—
    hlog.Infof("{{.Name}} called with args: %+v", {{range $i, $arg := .Args}}{{if $i}}, {{end}}{{$arg.Name}}{{end}})

    // Finish your business logic.

    // æ·»åŠ æ–¹æ³•è¿”å›æ—¥å¿—
    hlog.Infof("{{.Name}} returned: resp=%+v, err=%v", resp, err)
    return
  }
```

#### åœºæ™¯ 2ï¼šæ·»åŠ æ•°æ®åº“äº‹åŠ¡æ”¯æŒ

**ä¿®æ”¹æ–‡ä»¶**ï¼š`tpl/kitex/server/standard/service.yaml`

```yaml
body: |-
  import (
    "context"
    "gorm.io/gorm"
  )

  type {{.Name}}Service struct {
    ctx    context.Context
    db     *gorm.DB
  }

  func New{{.Name}}Service(ctx context.Context, db *gorm.DB) *{{.Name}}Service {
    return &{{.Name}}Service{ctx: ctx, db: db}
  }

  func (s *{{.Name}}Service) Run({{range .Args}}{{LowerFirst .Name}} {{.Type}}, {{end}}) (resp {{.Resp.Type}}, err error) {
    // ä½¿ç”¨äº‹åŠ¡
    tx := s.db.Begin()
    defer func() {
      if r := recover(); r != nil {
        tx.Rollback()
        panic(r)
      } else if err != nil {
        tx.Rollback()
      } else {
        tx.Commit()
      }
    }()

    // ä½¿ç”¨ tx æ‰§è¡Œä¸šåŠ¡é€»è¾‘...

    return
  }
```

#### åœºæ™¯ 3ï¼šä¿®æ”¹ Hertz ä¸»ç¨‹åºç»“æ„

**ä¿®æ”¹æ–‡ä»¶**ï¼š`tpl/hertz/server/standard/layout.yaml`

```yaml
# æ·»åŠ ä¼˜é›…å…³é—­
body: |-
  import (
    "context"
    "os"
    "os/signal"
    "syscall"
    "time"
  )

  func main() {
    address := conf.GetConf().Hertz.Address
    h := server.New(server.WithHostPorts(address))

    registerMiddleware(h)
    router.GeneratedRegister(h)

    // ä¼˜é›…å…³é—­
    go func() {
      if err := h.Spin(); err != nil {
        hlog.Errorf("Hertz server error: %v", err)
      }
    }()

    // ç­‰å¾…ä¸­æ–­ä¿¡å·
    quit := make(chan os.Signal, 1)
    signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM)
    <-quit

    hlog.Info("Shutting down server...")
    ctx, cancel := context.WithTimeout(context.Background(), 10*time.Second)
    defer cancel()

    if err := h.Shutdown(ctx); err != nil {
      hlog.Errorf("Server forced to shutdown: %v", err)
    }

    hlog.Info("Server exited")
  }
```

### 6.2 æ·»åŠ æ–°çš„å‘½ä»¤å‚æ•°

#### æ­¥éª¤ 1ï¼šä¿®æ”¹é…ç½®ç»“æ„

**æ–‡ä»¶**ï¼š`config/server.go`

```go
type ServerArgument struct {
    *CommonParam

    // ç°æœ‰å­—æ®µ...
    Template   string
    Branch     string
    Verbose    bool
    Hex        bool

    // æ·»åŠ ä½ çš„è‡ªå®šä¹‰å­—æ®µ
    EnableCache      bool    // å¯ç”¨ç¼“å­˜
    CacheType        string  // ç¼“å­˜ç±»å‹ï¼ˆredis/memoryï¼‰
    EnableTracing    bool    // å¯ç”¨é“¾è·¯è¿½è¸ª
    TracingExporter  string  // è¿½è¸ªå¯¼å‡ºå™¨
    EnableMetrics    bool    // å¯ç”¨æŒ‡æ ‡
    MetricsPort      int     // æŒ‡æ ‡ç«¯å£
}
```

#### æ­¥éª¤ 2ï¼šæ·»åŠ  CLI æ ‡å¿—

**æ–‡ä»¶**ï¼š`cmd/static/server_flags.go`

```go
func serverFlags() []cli.Flag {
    return []cli.Flag{
        // ç°æœ‰æ ‡å¿—...

        // æ·»åŠ ä½ çš„æ ‡å¿—
        &cli.BoolFlag{
            Name:  "enable-cache",
            Usage: "Enable cache in generated code",
            Value: false,
        },
        &cli.StringFlag{
            Name:  "cache-type",
            Usage: "Cache type: redis or memory",
            Value: "memory",
        },
        &cli.BoolFlag{
            Name:  "enable-tracing",
            Usage: "Enable distributed tracing",
            Value: false,
        },
        &cli.StringFlag{
            Name:  "tracing-exporter",
            Usage: "Tracing exporter: jaeger, zipkin, stdout",
            Value: "stdout",
        },
        &cli.BoolFlag{
            Name:  "enable-metrics",
            Usage: "Enable metrics collection",
            Value: false,
        },
        &cli.IntFlag{
            Name:  "metrics-port",
            Usage: "Metrics server port",
            Value: 9090,
        },
    }
}
```

#### æ­¥éª¤ 3ï¼šåœ¨ç”Ÿæˆé€»è¾‘ä¸­ä½¿ç”¨

**æ–‡ä»¶**ï¼š`pkg/server/kitex.go` æˆ– `hz.go`

```go
func convertKitexArgs(sa *config.ServerArgument, kitexArgument *kargs.Arguments) error {
    // ... ç°æœ‰ä»£ç  ...

    // æ ¹æ®é…ç½®è®¾ç½®ä¸åŒçš„ç”Ÿæˆé€‰é¡¹
    if sa.EnableCache {
        // è®¾ç½®ç¼“å­˜ç›¸å…³çš„æ¨¡æ¿å˜é‡
        // æˆ–è€…é€‰æ‹©ä¸åŒçš„æ¨¡æ¿ç›®å½•
    }

    if sa.EnableTracing {
        // æ·»åŠ è¿½è¸ªç›¸å…³çš„å¯¼å…¥å’Œä»£ç 
    }

    return nil
}
```

#### æ­¥éª¤ 4ï¼šåœ¨æ¨¡æ¿ä¸­ä½¿ç”¨

**æ–‡ä»¶**ï¼š`tpl/kitex/server/standard/service.yaml`

```yaml
body: |-
  import (
    "context"
    {{- if .EnableCache }}
    "github.com/go-redis/redis/v8"
    {{- end}}
    {{- if .EnableTracing }}
    "go.opentelemetry.io/otel"
    {{- end}}
  )

  type {{.Name}}Service struct {
    ctx context.Context
    {{- if .EnableCache }}
    cache *redis.Client
    {{- end}}
  }

  func New{{.Name}}Service(ctx context.Context{{if .EnableCache}}, cache *redis.Client{{end}}) *{{.Name}}Service {
    return &{{.Name}}Service{
      ctx: ctx{{if .EnableCache}},
      cache: cache{{end}}
    }
  }

  func (s *{{.Name}}Service) Run({{range .Args}}{{LowerFirst .Name}} {{.Type}}, {{end}}) (resp {{.Resp.Type}}, err error) {
    {{- if .EnableTracing}}
    ctx, span := otel.Tracer("service").Start(s.ctx, "{{.Name}}")
    defer span.End()
    {{- end}}

    // ä¸šåŠ¡é€»è¾‘...

    return
  }
```

### 6.3 åˆ›å»ºå…¨æ–°çš„æ¨¡æ¿å¸ƒå±€

#### âš ï¸ é‡è¦æç¤º

åœ¨åˆ›å»ºè‡ªå®šä¹‰æ¨¡æ¿æ—¶ï¼Œ**æœ€å…³é”®çš„è¦ç‚¹**æ˜¯ï¼š

1. **å¿…é¡»ä¿ç•™ `FilterImports` åŠ¨æ€å¯¼å…¥é€»è¾‘**ï¼Œå¦åˆ™ç”Ÿæˆçš„ä»£ç æ— æ³•ç¼–è¯‘
2. **å…ˆå¤åˆ¶åŸå§‹æ¨¡æ¿ï¼Œå†è¿›è¡Œä¿®æ”¹**ï¼Œé¿å…é—æ¼å…³é”®éƒ¨åˆ†
3. **ç†è§£æ¨¡æ¿å˜é‡çš„ä½œç”¨**ï¼Œæ­£ç¡®ä½¿ç”¨æ¨¡æ¿è¯­æ³•

#### æ­¥éª¤ 1ï¼šåˆ›å»ºæ–°æ¨¡æ¿ç›®å½•

```bash
# åˆ›å»ºè‡ªå®šä¹‰å¸ƒå±€ç›®å½•
mkdir -p tpl/kitex/server/my_custom_layout

# æˆ–è€…åŸºäºæ ‡å‡†æ¨¡æ¿å¤åˆ¶
cp -r tpl/kitex/server/standard tpl/kitex/server/my_custom_layout
```

#### æ­¥éª¤ 2ï¼šåˆ›å»ºæ­£ç¡®çš„ service.yaml æ¨¡æ¿

**æ–‡ä»¶**ï¼š`tpl/kitex/server/my_custom_layout/service.yaml`

```yaml
path: internal/service/{{SnakeString .ServiceName}}/{{ SnakeString (index .Methods 0).Name }}.go
loop_method: true
update_behavior:
  type: skip
body: |-
  package {{SnakeString .ServiceName}}

  import (
    "context"

    {{- if .EnableCustomLogger }}
    "{{.GoModule}}/pkg/logger"
    {{- end}}
    {{- if .EnableCustomErrors }}
    "{{.GoModule}}/pkg/errors"
    {{- end}}

    {{- /* âš ï¸ å…³é”®ï¼šä¿ç•™åŠ¨æ€å¯¼å…¥é€»è¾‘ï¼Œå¦åˆ™ä¼šç¼–è¯‘å¤±è´¥ */}}
    {{- range $path, $aliases := ( FilterImports .Imports .Methods )}}
        {{- if not $aliases }}
            "{{$path}}"
        {{- else if or (eq $path "github.com/cloudwego/kitex/client") (eq $path "github.com/cloudwego/kitex/pkg/serviceinfo")}}
        {{- else}}
            {{- range $alias, $is := $aliases}}
                {{$alias}} "{{$path}}"
            {{- end}}
        {{- end}}
    {{- end}}
  )

  {{range .Methods}}

  type {{.Name}}Service struct {
    ctx context.Context
    {{- if .EnableCustomLogger }}
    log *logger.Logger
    {{- end}}
  }

  {{- if or .ClientStreaming .ServerStreaming}}

  // New{{.Name}}Service new {{.Name}}Service
  func New{{.Name}}Service(ctx context.Context{{if .EnableCustomLogger}}, log *logger.Logger{{end}}) *{{.Name}}Service {
    return &{{.Name}}Service{
      ctx: ctx{{if .EnableCustomLogger}},
      log: log{{end}}
    }
  }

  func (s *{{.Name}}Service) Run({{if not .ClientStreaming}}{{range .Args}}{{LowerFirst .Name}} {{.Type}}, {{end}}{{end}}stream {{.PkgRefName}}.{{.ServiceName}}_{{.RawName}}Server) (err error) {
    {{- if .EnableCustomLogger }}
    s.log.Infof("[{{.Name}}] Service called (streaming)")
    {{- end}}

    defer func() {
      {{- if .EnableCustomLogger }}
      if r := recover(); r != nil {
        s.log.Errorf("[{{.Name}}] panic: %v", r)
        panic(r)
      }
      {{- end}}
    }()

    // Finish your business logic.
    return
  }
  {{- else}}
  {{- if .Void}}

  func New{{.Name}}Service(ctx context.Context{{if .EnableCustomLogger}}, log *logger.Logger{{end}}) *{{.Name}}Service {
    return &{{.Name}}Service{
      ctx: ctx{{if .EnableCustomLogger}},
      log: log{{end}}
    }
  }

  func (s *{{.Name}}Service) Run({{range .Args}}{{LowerFirst .Name}} {{.Type}}, {{end}}) error {
    {{- if .EnableCustomLogger }}
    s.log.Infof("[{{.Name}}] Service called with args: %+v", {{range $i, $arg := .Args}}{{if $i}}, {{end}}{{$arg.Name}}{{end}})
    {{- end}}

    defer func() {
      {{- if .EnableCustomLogger }}
      if r := recover(); r != nil {
        s.log.Errorf("[{{.Name}}] panic: %v", r)
        panic(r)
      }
      {{- end}}
    }()

    // Finish your business logic.

    return nil
  }
  {{else}}

  func New{{.Name}}Service(ctx context.Context{{if .EnableCustomLogger}}, log *logger.Logger{{end}}) *{{.Name}}Service {
    return &{{.Name}}Service{
      ctx: ctx{{if .EnableCustomLogger}},
      log: log{{end}}
    }
  }

  func (s *{{.Name}}Service) Run({{range .Args}}{{LowerFirst .Name}} {{.Type}}, {{end}}) (resp {{.Resp.Type}}, err error) {
    {{- if .EnableCustomLogger }}
    s.log.Infof("[{{.Name}}] Service called with args: %+v", {{range $i, $arg := .Args}}{{if $i}}, {{end}}{{$arg.Name}}{{end}})

    defer func() {
      if r := recover(); r != nil {
        {{- if .EnableCustomErrors }}
        err = errors.NewPanicError(r)
        {{- end}}
        s.log.Errorf("[{{.Name}}] panic: %v", r)
        panic(r)
      } else if err != nil {
        s.log.Errorf("[{{.Name}}] failed: %v", err)
        {{- if .EnableCustomErrors }}
        err = errors.Wrap(err, "{{.Name}} failed")
        {{- end}}
      } else {
        s.log.Infof("[{{.Name}}] succeeded")
      }
    }()
    {{- end}}

    // Finish your business logic.

    return
  }
  {{end}}
  {{end}}
  {{end}}
```

#### ğŸ“Š æ¨¡æ¿å…³é”®è¦ç´ è¯´æ˜

| è¦ç´  | è¯´æ˜ | é”™è¯¯ç¤ºä¾‹ âœ— | æ­£ç¡®ç¤ºä¾‹ âœ“ |
|------|------|-----------|----------|
| **åŠ¨æ€å¯¼å…¥** | ä½¿ç”¨ `FilterImports` è‡ªåŠ¨å¯¼å…¥ IDL ç±»å‹ | `import ("context")` | `{{range $path, $aliases := ( FilterImports .Imports .Methods )}}` |
| **è·¯å¾„å˜é‡** | ä½¿ç”¨æ­£ç¡®çš„æ¨¡æ¿å˜é‡ | `path: service.go` | `path: internal/service/{{SnakeString .ServiceName}}/...` |
| **æ¡ä»¶æ¸²æŸ“** | æ ¹æ®é…ç½®æ¡ä»¶ç”Ÿæˆä»£ç  | `log *logger.Logger` | `{{if .EnableCustomLogger}}log *logger.Logger{{end}}` |
| **å¾ªç¯æ–¹æ³•** | ä¸ºæ¯ä¸ªæ–¹æ³•ç”Ÿæˆç‹¬ç«‹æ–‡ä»¶ | åˆ é™¤ `loop_method` | `loop_method: true` |
| **æ›´æ–°è¡Œä¸º** | æ§åˆ¶æ–‡ä»¶è¦†ç›–ç­–ç•¥ | `type: cover` | `type: skip` |

#### æ­¥éª¤ 3ï¼šåˆ›å»ºé…å¥—çš„ main æ¨¡æ¿

**æ–‡ä»¶**ï¼š`tpl/kitex/server/my_custom_layout/main_tpl.yaml`

```yaml
path: cmd/server/main.go
body: |-
  package main

  import (
    "context"
    "flag"

    {{- if .EnableCustomConfig }}
    "{{.GoModule}}/pkg/config"
    {{- end}}
    {{- if .EnableCustomLogger }}
    "{{.GoModule}}/pkg/logger"
    {{- end}}

    "{{.GoModule}}/kitex_gen/{{SnakeString .ServiceName}}/{{.ServiceName}}"
    "{{.GoModule}}/internal/service/{{SnakeString .ServiceName}}"
  )

  var (
    {{- if .EnableCustomConfig }}
    configFile = flag.String("c", "configs/config.yaml", "config file path")
    {{- end}}
  )

  func main() {
    flag.Parse()

    {{- if .EnableCustomConfig }}
    // åˆå§‹åŒ–é…ç½®
    cfg, err := config.Load(*configFile)
    if err != nil {
      panic(err)
    }

    // åˆå§‹åŒ–æ—¥å¿—
    {{- if .EnableCustomLogger }}
    log := logger.New(cfg.Log)
    {{- end}}
    {{- end}}

    // åˆ›å»ºæœåŠ¡å®ç°
    {{if .EnableCustomLogger}}
    svr := {{.ServiceName}}.NewServer(new({{SnakeString .ServiceName}}.{{.ServiceName}}ServiceImpl))
    {{- else}}
    svr := {{.ServiceName}}.NewServer(new({{SnakeString .ServiceName}}.{{.ServiceName}}ServiceImpl))
    {{- end}}

    // å¯åŠ¨æœåŠ¡
    if err := svr.Run(); err != nil {
      panic(err)
    }
  }
```

#### æ­¥éª¤ 4ï¼šæ³¨å†Œæ¨¡æ¿ï¼ˆå¯é€‰ï¼‰

å¦‚æœä¸æƒ³é€šè¿‡ `-template` å‚æ•°æŒ‡å®šï¼Œå¯ä»¥åœ¨ `tpl/init.go` ä¸­æ³¨å†Œï¼š

```go
// âš ï¸ æ³¨æ„ï¼šcwgo çš„æ¨¡æ¿ç³»ç»Ÿé€šè¿‡ -template å‚æ•°åŠ¨æ€æŒ‡å®š
// ä¸éœ€è¦ä¿®æ”¹ tpl/init.goï¼Œç›´æ¥é€šè¿‡å‘½ä»¤è¡Œå‚æ•°ä½¿ç”¨å³å¯
```

#### æ­¥éª¤ 5ï¼šä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ¿

```bash
# æ–¹å¼ 1ï¼šé€šè¿‡ -template å‚æ•°æŒ‡å®šï¼ˆæ¨èï¼‰
cwgo server -type rpc \
  -module github.com/your/project \
  -service user.service \
  -idl idl/user.thrift \
  -template tpl/kitex/server/my_custom_layout

# æ–¹å¼ 2ï¼šä½¿ç”¨é…ç½®æ–‡ä»¶å¯ç”¨è‡ªå®šä¹‰åŠŸèƒ½
cwgo server -type rpc \
  -module github.com/your/project \
  -service user.service \
  -idl idl/user.thrift \
  -enable-custom-logger \
  -enable-custom-errors \
  -template tpl/kitex/server/my_custom_layout
```

#### æ­¥éª¤ 6ï¼šæ·»åŠ é…ç½®å‚æ•°æ”¯æŒ

ä¸ºäº†è®©æ¨¡æ¿ä¸­çš„æ¡ä»¶å˜é‡ç”Ÿæ•ˆï¼Œéœ€è¦æ·»åŠ å¯¹åº”çš„é…ç½®å‚æ•°ï¼š

**æ–‡ä»¶**ï¼š`config/server.go`

```go
type ServerArgument struct {
    *CommonParam

    Template   string
    Branch     string
    Verbose    bool
    Hex        bool

    // æ·»åŠ è‡ªå®šä¹‰åŠŸèƒ½å¼€å…³
    EnableCustomLogger  bool  // æ˜¯å¦ç”Ÿæˆå¸¦æ—¥å¿—çš„ä»£ç 
    EnableCustomErrors  bool  // æ˜¯å¦ä½¿ç”¨è‡ªå®šä¹‰é”™è¯¯åŒ…
    EnableCustomConfig  bool  // æ˜¯å¦ä½¿ç”¨è‡ªå®šä¹‰é…ç½®
}
```

**æ–‡ä»¶**ï¼š`cmd/static/server_flags.go`

```go
func serverFlags() []cli.Flag {
    return []cli.Flag{
        // ç°æœ‰æ ‡å¿—...

        // è‡ªå®šä¹‰åŠŸèƒ½æ ‡å¿—
        &cli.BoolFlag{
            Name:  "enable-custom-logger",
            Usage: "Generate code with custom logger integration",
            Value: false,
        },
        &cli.BoolFlag{
            Name:  "enable-custom-errors",
            Usage: "Generate code with custom error wrapping",
            Value: false,
        },
        &cli.BoolFlag{
            Name:  "enable-custom-config",
            Usage: "Generate code with custom config loading",
            Value: false,
        },
    }
}
```

#### ğŸ¯ å®Œæ•´ç¤ºä¾‹å¯¹æ¯”

**åŸå§‹æ¨¡æ¿ç”Ÿæˆ**ï¼š
```go
package userservice

import (
    "context"
    // ... IDL ç›¸å…³å¯¼å…¥
)

type GetUserService struct {
    ctx context.Context
}

func NewGetUserService(ctx context.Context) *GetUserService {
    return &GetUserService{ctx: ctx}
}

func (s *GetUserService) Run(req Request) (resp *Response, err error) {
    // Finish your business logic.
    return
}
```

**è‡ªå®šä¹‰æ¨¡æ¿ç”Ÿæˆï¼ˆå¯ç”¨æ—¥å¿—å’Œé”™è¯¯å¤„ç†ï¼‰**ï¼š
```go
package userservice

import (
    "context"
    "github.com/your/project/pkg/logger"
    "github.com/your/project/pkg/errors"
    // ... IDL ç›¸å…³å¯¼å…¥ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
)

type GetUserService struct {
    ctx context.Context
    log *logger.Logger
}

func NewGetUserService(ctx context.Context, log *logger.Logger) *GetUserService {
    return &GetUserService{
        ctx: ctx,
        log: log,
    }
}

func (s *GetUserService) Run(req Request) (resp *Response, err error) {
    s.log.Infof("[GetUser] Service called with args: %+v", req)

    defer func() {
      if r := recover(); r != nil {
        err = errors.NewPanicError(r)
        s.log.Errorf("[GetUser] panic: %v", r)
        panic(r)
      } else if err != nil {
        s.log.Errorf("[GetUser] failed: %v", err)
        err = errors.Wrap(err, "GetUser failed")
      } else {
        s.log.Infof("[GetUser] succeeded")
      }
    }()

    // Finish your business logic.
    return
}
```

#### ğŸ’¡ æœ€ä½³å®è·µ

1. **æ¸è¿›å¼å®šåˆ¶**ï¼š
   ```bash
   # æ­¥éª¤ 1ï¼šå…ˆå¤åˆ¶æ ‡å‡†æ¨¡æ¿
   cp -r tpl/kitex/server/standard tpl/kitex/server/custom

   # æ­¥éª¤ 2ï¼šä¿®æ”¹å•ä¸ªæ–‡ä»¶æµ‹è¯•
   vim tpl/kitex/server/custom/service.yaml

   # æ­¥éª¤ 3ï¼šæµ‹è¯•ç”Ÿæˆ
   ./cwgo server -type rpc -template tpl/kitex/server/custom ...

   # æ­¥éª¤ 4ï¼šéªŒè¯ç¼–è¯‘
   cd output && go build
   ```

2. **ç‰ˆæœ¬æ§åˆ¶**ï¼š
   ```bash
   # ä½¿ç”¨ Git ç®¡ç†è‡ªå®šä¹‰æ¨¡æ¿
   git add tpl/kitex/server/custom/
   git commit -m "Add custom template with logging"
   ```

3. **æ–‡æ¡£åŒ–**ï¼š
   ```markdown
   # è‡ªå®šä¹‰æ¨¡æ¿è¯´æ˜
   ## è·¯å¾„
   tpl/kitex/server/my_custom_layout/

   ## ç‰¹æ€§
   - é›†æˆç»Ÿä¸€æ—¥å¿—
   - é”™è¯¯åŒ…è£…
   - Panic æ¢å¤
   - æ–¹æ³•è°ƒç”¨è¿½è¸ª

   ## ä½¿ç”¨
   cwgo server -template tpl/kitex/server/my_custom_layout ...
   ```

#### âš ï¸ å¸¸è§é”™è¯¯

| é”™è¯¯ç°è±¡ | åŸå›  | è§£å†³æ–¹æ³• |
|---------|------|---------|
| `undefined: Request` | ç¼ºå°‘åŠ¨æ€å¯¼å…¥ | ä¿ç•™ `FilterImports` é€»è¾‘ |
| `undefined: logger` | æœªå¯ç”¨è‡ªå®šä¹‰æ—¥å¿— | æ·»åŠ æ¡ä»¶åˆ¤æ–­æˆ–å¯¼å…¥åŒ… |
| æ¨¡æ¿å˜é‡ä¸ç”Ÿæ•ˆ | æ‹¼å†™é”™è¯¯æˆ–æœªä¼ é€’ | æ£€æŸ¥å˜é‡åå’Œé…ç½®å‚æ•° |
| ç”Ÿæˆè·¯å¾„é”™è¯¯ | path æ¨¡æ¿è¯­æ³•é”™è¯¯ | æ£€æŸ¥æ¨¡æ¿å˜é‡å’Œè¯­æ³• |

### 6.4 æ·»åŠ æ–°çš„ç”Ÿæˆå‘½ä»¤

#### åœºæ™¯ï¼šåˆ›å»ºä¸€ä¸ªå®Œæ•´çš„å¾®æœåŠ¡ç”Ÿæˆå‘½ä»¤

**æ­¥éª¤ 1**ï¼šå®šä¹‰æ–°å‘½ä»¤

**æ–‡ä»¶**ï¼š`cmd/static/cmd.go`

```go
const (
    ServerName   = "server"
    ClientName   = "client"
    ModelName    = "model"
    DocName      = "doc"
    JobName      = "job"
    ApiListName  = "api_list"
    MicroServiceName = "microservice"  // æ–°å¢
)

func Init() *cli.App {
    // ...

    app.Commands = []*cli.Command{
        // ç°æœ‰å‘½ä»¤...

        {
            Name:  MicroServiceName,
            Usage: "Generate a complete microservice with server, client, and models",
            Flags: microserviceFlags(),
            Action: func(c *cli.Context) error {
                err := globalArgs.MicroServiceArgument.ParseCli(c)
                if err != nil {
                    return err
                }
                return microservice.Generate(globalArgs.MicroServiceArgument)
            },
        },
    }

    return app
}
```

### 6.5 é«˜çº§å®šåˆ¶ï¼šService ç¼–æ’ä¸ Processor ç®—å­åŒ–

#### 6.5.1 æ ¸å¿ƒç†å¿µ

ä¸ºäº†è§£å†³å¤æ‚ä¸šåŠ¡åœºæ™¯ä¸‹ Service å±‚ä»£ç è‡ƒè‚¿ã€éš¾ä»¥æµ‹è¯•çš„é—®é¢˜ï¼Œæ¨èé‡‡ç”¨**é€»è¾‘ç¼–æ’ä¸ç®—å­åŒ–**çš„è®¾è®¡æ¨¡å¼ã€‚

**æ³¨æ„**ï¼šæ­¤æ¨¡å¼ä¸»è¦é€‚ç”¨äºæ‰¿è½½æ ¸å¿ƒä¸šåŠ¡é€»è¾‘çš„ **Kitex (RPC)** æœåŠ¡ã€‚å¯¹äº **Hertz (HTTP)** æœåŠ¡ï¼Œé€šå¸¸æ¨èé‡‡ç”¨ API Gateway æ¨¡å¼ï¼Œç›´æ¥è°ƒç”¨ä¸‹æ¸¸ RPC æœåŠ¡ï¼Œä¿æŒè½»é‡çº§ï¼Œä¸éœ€è¦å¤æ‚çš„æœ¬åœ°ç¼–æ’ã€‚

æ ¸å¿ƒæ€æƒ³æ˜¯å°† Kitex Service å±‚åšè–„ï¼Œä»…è´Ÿè´£ç­–ç•¥åˆ†å‘ï¼›å°†ä¸šåŠ¡é€»è¾‘ä¸‹æ²‰ä¸ºæ— çŠ¶æ€çš„åŸå­ç®—å­ï¼ˆProcessorï¼‰ï¼›é€šè¿‡ç‹¬ç«‹çš„ Strategy å±‚åœ¨ `init` é˜¶æ®µå®Œæˆé€»è¾‘ç¼–æ’ï¼ˆä¸²è¡Œæˆ– DAGï¼‰ã€‚

#### 6.5.2 æ¶æ„åˆ†å±‚ (Kitex)

| å±‚çº§ | èŒè´£ | ç”Ÿæˆç­–ç•¥ | è¯´æ˜ |
|------|------|----------|------|
| **Service å±‚** | **åˆ†å‘** | `Skip` (æ¨è) | å®šä¹‰æ¥å£æ ‡å‡†å’Œå…¨å±€ç­–ç•¥ Mapï¼Œè¿è¡Œæ—¶æŸ¥è¡¨æ‰§è¡Œã€‚ä¿ç•™ `Skip` ä»¥å…è®¸ç”¨æˆ·ç¼–å†™åŠ¨æ€è·¯ç”±é€»è¾‘ã€‚ |
| **Strategy å±‚** | **ç¼–æ’** | `Skip` (ä¸è¦†ç›–) | ç”¨æˆ·åœ¨æ­¤ç¼–å†™ `init` å‡½æ•°ï¼Œå°† Processor ç®—å­ç»„è£…æˆæ‰§è¡Œæµï¼Œæ³¨å†Œåˆ° Map ä¸­ã€‚ |
| **Processor å±‚** | **æ‰§è¡Œ** | ä»…ç”Ÿæˆ Doc | ç”¨æˆ·è‡ªç ”çš„åŸå­ä¸šåŠ¡é€»è¾‘ï¼Œçº¯ Go ä»£ç ï¼Œä¸æ¡†æ¶è§£è€¦ã€‚ |

#### 6.5.3 ç›®å½•ç»“æ„ç¤ºä¾‹

```text
biz/
â”œâ”€â”€ service/              # [è‡ªåŠ¨ç”Ÿæˆ] Service å£³ï¼Œè´Ÿè´£åˆ†å‘
â”‚   â””â”€â”€ user/
â”‚       â””â”€â”€ get_user.go   
â”œâ”€â”€ strategy/             # [è‡ªåŠ¨ç”Ÿæˆä¸€æ¬¡] ç­–ç•¥ç¼–æ’å±‚ï¼Œç”¨æˆ·åœ¨æ­¤å¤„ç”± init ç»„è£… Processor
â”‚   â””â”€â”€ user/
â”‚       â””â”€â”€ get_user.go   
â””â”€â”€ processor/            # [ç”¨æˆ·è‡ªç ”] åŸå­ä¸šåŠ¡é€»è¾‘ï¼Œæ— ä»£ç ç”Ÿæˆå¹²æ‰°
    â””â”€â”€ doc.go            # ä»…ç”Ÿæˆæ–‡æ¡£å ä½
    â””â”€â”€ user/
        â”œâ”€â”€ check_permission.go
        â””â”€â”€ query_db.go
```

#### 6.5.4 å®ç°ä»£ç ç¤ºä¾‹

**1. Service å±‚ï¼ˆç”Ÿæˆçš„å£³ï¼‰**

```go
// biz/service/user/get_user.go
package user_service

import (
    "context"
    "errors"
    user "example/kitex_gen/user" 
)

// å®šä¹‰ç»Ÿä¸€çš„ Handler ç­¾å
type GetUserHandler func(ctx context.Context, req *user.GetUserRequest) (resp *user.GetUserResponse, err error)

// å…¨å±€ç­–ç•¥ Mapï¼Œç”¨äºå­˜å‚¨ç¼–æ’å¥½çš„é€»è¾‘
var GetUserStrategies = make(map[string]GetUserHandler)

type GetUserService struct {
    ctx context.Context
}

// Run æ–¹æ³•è´Ÿè´£æŸ¥è¡¨æ‰§è¡Œ
func (s *GetUserService) Run(req *user.GetUserRequest) (resp *user.GetUserResponse, err error) {
    // --- è·¯ç”±é€‰æ‹©é€»è¾‘ (ç”¨æˆ·å¯æ‰©å±•) ---
    strategyName := "default" 
    // if req.Type == "vip" { strategyName = "vip_channel" }
    
    if handler, ok := GetUserStrategies[strategyName]; ok {
        return handler(s.ctx, req)
    }
    
    return nil, errors.New("strategy not found")
}
```

**2. Strategy å±‚ï¼ˆç¼–æ’å…¥å£ï¼‰**

```go
// biz/strategy/user/get_user.go
package user_strategy

import (
    "context"
    "example/biz/service/user"             // å¯¼å…¥ Service å®šä¹‰
    "example/biz/processor/user_processor" // å¯¼å…¥ Processor ç®—å­
)

func init() {
    // åœ¨ init ä¸­æ³¨å†Œå…·ä½“çš„ç¼–æ’é€»è¾‘
    user_service.GetUserStrategies["default"] = func(ctx context.Context, req *user.GetUserRequest) (*user.GetUserResponse, error) {
        
        // --- ç¼–æ’é€»è¾‘ (ä¸²è¡Œç¤ºä¾‹) ---
        
        // 1. ç®—å­ A: æ£€æŸ¥æƒé™
        if err := user_processor.CheckPermission(ctx, req.UserId); err != nil {
            return nil, err
        }
        
        // 2. ç®—å­ B: æŸ¥è¯¢æ•°æ®
        userInfo, err := user_processor.QueryUserInfo(ctx, req.UserId)
        if err != nil {
            return nil, err
        }
        
        return &user.GetUserResponse{User: userInfo}, nil
    }
}
```

**3. Processor å±‚ï¼ˆåŸå­ç®—å­ï¼‰**

```go
// biz/processor/user/check_permission.go
package user_processor

// çº¯å‡½æ•°ï¼Œæ˜“äºæµ‹è¯•å’Œå¤ç”¨
func CheckPermission(ctx context.Context, userID int64) error {
    // å…·ä½“å®ç°...
    return nil
}
```

#### 6.5.5 Hertz æ¨èæ¶æ„ (Gateway æ¨¡å¼)

å¯¹äº Hertz æœåŠ¡ï¼Œå»ºè®®ä¿æŒè½»é‡çº§ï¼š

*   **Handler**: ç›´æ¥è°ƒç”¨ RPC Clientã€‚
*   **Service**: å¯é€‰ï¼Œä»…ä½œç®€å•å°è£…ã€‚
*   **Processor**: ä¸æ¨èåœ¨ Gateway å±‚å®ç°å¤æ‚é€»è¾‘ã€‚

è¿™æ ·å½¢æˆäº† **Hertz (ç½‘å…³) -> Kitex (ä¸šåŠ¡ç¼–æ’)** çš„æ¸…æ™°åˆ†å±‚ã€‚

**æ­¥éª¤ 2**ï¼šå®šä¹‰é…ç½®ç»“æ„

**æ–‡ä»¶**ï¼š`config/microservice.go`

```go
package config

import "github.com/urfave/cli/v2"

type MicroServiceArgument struct {
    *CommonParam

    // æ•°æ®åº“é…ç½®
    EnableDatabase bool
    DbType         string
    DSN            string
    Tables         []string

    // ç¼“å­˜é…ç½®
    EnableCache bool
    CacheType   string

    // è¿½è¸ªé…ç½®
    EnableTracing   bool
    TracingExporter string

    // æŒ‡æ ‡é…ç½®
    EnableMetrics bool
    MetricsPort   int
}

func NewMicroServiceArgument() *MicroServiceArgument {
    return &MicroServiceArgument{
        CommonParam: &CommonParam{},
    }
}

func (m *MicroServiceArgument) ParseCli(ctx *cli.Context) error {
    // è§£æå‚æ•°
    m.ServerName = ctx.String("service")
    m.GoMod = ctx.String("module")
    m.IdlPath = ctx.String("idl")
    m.OutDir = ctx.String("out-dir")

    m.EnableDatabase = ctx.Bool("enable-database")
    m.DbType = ctx.String("db-type")
    m.DSN = ctx.String("dsn")

    // ... å…¶ä»–å‚æ•°

    return nil
}
```

**æ­¥éª¤ 3**ï¼šå®ç°ç”Ÿæˆé€»è¾‘

**æ–‡ä»¶**ï¼š`pkg/microservice/generator.go`

```go
package microservice

import (
    "github.com/cloudwego/cwgo/config"
    "github.com/cloudwego/cwgo/pkg/client"
    "github.com/cloudwego/cwgo/pkg/model"
    "github.com/cloudwego/cwgo/pkg/server"
)

func Generate(c *config.MicroServiceArgument) error {
    // 1. ç”ŸæˆæœåŠ¡å™¨
    serverArg := convertToServerArg(c)
    if err := server.Server(serverArg); err != nil {
        return err
    }

    // 2. ç”Ÿæˆå®¢æˆ·ç«¯
    clientArg := convertToClientArg(c)
    if err := client.Client(clientArg); err != nil {
        return err
    }

    // 3. ç”Ÿæˆæ•°æ®åº“æ¨¡å‹
    if c.EnableDatabase {
        modelArg := convertToModelArg(c)
        if err := model.Model(modelArg); err != nil {
            return err
        }
    }

    // 4. ç”Ÿæˆ Docker é…ç½®
    if err := generateDockerCompose(c); err != nil {
        return err
    }

    // 5. ç”Ÿæˆéƒ¨ç½²è„šæœ¬
    if err := generateDeployScripts(c); err != nil {
        return err
    }

    return nil
}

func convertToServerArg(c *config.MicroServiceArgument) *config.ServerArgument {
    return &config.ServerArgument{
        CommonParam: c.CommonParam,
        // ... æ˜ å°„å…¶ä»–å­—æ®µ
    }
}
```

**æ­¥éª¤ 4**ï¼šå®šä¹‰å‘½ä»¤æ ‡å¿—

**æ–‡ä»¶**ï¼š`cmd/static/microservice_flags.go`

```go
package static

import "github.com/urfave/cli/v2"

const (
    MicroServiceUsage = "Generate a complete microservice"
)

func microserviceFlags() []cli.Flag {
    return []cli.Flag{
        // åŸºç¡€å‚æ•°
        &cli.StringFlag{
            Name:     "service",
            Required: true,
            Usage:    "Service name",
        },
        &cli.StringFlag{
            Name:     "module",
            Required: true,
            Usage:    "Go module name",
        },
        &cli.StringFlag{
            Name:     "idl",
            Required: true,
            Usage:    "IDL file path",
        },

        // æ•°æ®åº“å‚æ•°
        &cli.BoolFlag{
            Name:  "enable-database",
            Usage: "Enable database model generation",
            Value: false,
        },
        &cli.StringFlag{
            Name:  "db-type",
            Usage: "Database type: mysql, postgres, sqlite",
            Value: "mysql",
        },
        &cli.StringFlag{
            Name:  "dsn",
            Usage: "Database DSN",
        },

        // ç¼“å­˜å‚æ•°
        &cli.BoolFlag{
            Name:  "enable-cache",
            Usage: "Enable cache",
            Value: false,
        },
        &cli.StringFlag{
            Name:  "cache-type",
            Usage: "Cache type: redis, memory",
            Value: "redis",
        },

        // è¿½è¸ªå‚æ•°
        &cli.BoolFlag{
            Name:  "enable-tracing",
            Usage: "Enable distributed tracing",
            Value: false,
        },
    }
}
```

---

## ä¸ƒã€å®æˆ˜æ¡ˆä¾‹

### 7.1 æ¡ˆä¾‹ 1ï¼šé›†æˆå…¬å¸å†…éƒ¨ç»„ä»¶åº“

**éœ€æ±‚**ï¼šå°†ç”Ÿæˆçš„ä»£ç é›†æˆåˆ°å…¬å¸å†…éƒ¨çš„åŸºç¡€è®¾æ–½ä¸­ï¼ŒåŒ…æ‹¬ï¼š
- ç»Ÿä¸€çš„æ—¥å¿—åº“
- ç»Ÿä¸€çš„é…ç½®ä¸­å¿ƒ
- ç»Ÿä¸€çš„ç›‘æ§å’Œè¿½è¸ª

#### è§£å†³æ–¹æ¡ˆ

1. **ä¿®æ”¹ main.go æ¨¡æ¿**

```yaml
# tpl/kitex/server/standard/main_tpl.yaml
body: |-
  package main

  import (
    "context"
    "flag"

    "your-company/internal/config"
    "your-company/pkg/logger"
    "your-company/pkg/metrics"
    "your-company/pkg/tracing"
  )

  var (
    configFile = flag.String("c", "configs/config.yaml", "config file path")
  )

  func main() {
    flag.Parse()

    // åˆå§‹åŒ–é…ç½®ä¸­å¿ƒ
    cfg, err := config.LoadFromCenter(*configFile)
    if err != nil {
      panic(err)
    }

    // åˆå§‹åŒ–æ—¥å¿—
    logger.Init(cfg.Log)

    // åˆå§‹åŒ–è¿½è¸ª
    if cfg.Tracing.Enabled {
      tracing.Init(cfg.Tracing)
    }

    // åˆå§‹åŒ–æŒ‡æ ‡
    if cfg.Metrics.Enabled {
      metrics.Init(cfg.Metrics)
    }

    // åˆ›å»ºæœåŠ¡
    svr := {{.ServiceName}}.NewServer(new({{.ServiceName}}Impl))

    // å¯åŠ¨æœåŠ¡
    svr.Run()
  }
```

2. **ä¿®æ”¹ service æ¨¡æ¿**

```yaml
# tpl/kitex/server/standard/service.yaml
body: |-
  import (
    "context"
    "your-company/pkg/logger"
    "your-company/pkg/errors"
  )

  type {{.Name}}Service struct {
    ctx context.Context
    log *logger.Logger
  }

  func New{{.Name}}Service(ctx context.Context) *{{.Name}}Service {
    return &{{.Name}}Service{
      ctx: ctx,
      log: logger.FromContext(ctx),
    }
  }

  func (s *{{.Name}}Service) Run({{range .Args}}{{LowerFirst .Name}} {{.Type}}, {{end}}) (resp {{.Resp.Type}}, err error) {
    s.log.Infof("[{{.Name}}] Service called")

    defer func() {
      if err != nil {
        s.log.Errorf("[{{.Name}}] Service failed: %v", err)
        err = errors.Wrap(err, "{{.Name}} failed")
      }
    }()

    // ä¸šåŠ¡é€»è¾‘...

    return
  }
}
```

### 7.2 æ¡ˆä¾‹ 2ï¼šç”Ÿæˆå¸¦ç¼“å­˜çš„æœåŠ¡ä»£ç 

**éœ€æ±‚**ï¼šè‡ªåŠ¨ä¸ºæ‰€æœ‰æŸ¥è¯¢æ–¹æ³•æ·»åŠ ç¼“å­˜æ”¯æŒ

#### è§£å†³æ–¹æ¡ˆ

1. **æ·»åŠ é…ç½®å‚æ•°**

```go
// config/server.go
type ServerArgument struct {
    // ...
    EnableCache bool
    CacheType   string // redis, memory
    CacheTTL    int    // ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
}
```

2. **ä¿®æ”¹ service æ¨¡æ¿**

```yaml
# tpl/kitex/server/standard/service.yaml
body: |-
  import (
    "context"
    "encoding/json"
    "time"
    {{- if eq .CacheType "redis" }}
    "github.com/go-redis/redis/v8"
    {{- end}}
  )

  type {{.Name}}Service struct {
    ctx context.Context
    {{- if eq .CacheType "redis" }}
    redis *redis.Client
    {{- end}}
  }

  func New{{.Name}}Service(ctx context.Context{{if eq .CacheType "redis"}}, rdb *redis.Client{{end}}) *{{.Name}}Service {
    return &{{.Name}}Service{
      ctx: ctx{{if eq .CacheType "redis"}},
      redis: rdb{{end}}
    }
  }

  {{if not .Void}}func (s *{{.Name}}Service) Run({{range .Args}}{{LowerFirst .Name}} {{.Type}}, {{end}}) (resp {{.Resp.Type}}, err error) {
    {{- if eq .CacheType "redis"}}
    // ç”Ÿæˆç¼“å­˜é”®
    cacheKey := s.buildCacheKey({{range $i, $arg := .Args}}{{if $i}}, {{end}}{{$arg.Name}}{{end}})

    // å°è¯•ä»ç¼“å­˜è·å–
    cached, err := s.redis.Get(s.ctx, cacheKey).Result()
    if err == nil {
      json.Unmarshal([]byte(cached), &resp)
      return resp, nil
    }

    // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    resp, err = s.runBusinessLogic({{range .Args}}{{LowerFirst .Name}}, {{end}})
    if err != nil {
      return resp, err
    }

    // ç¼“å­˜ç»“æœ
    data, _ := json.Marshal(resp)
    s.redis.Set(s.ctx, cacheKey, data, time.Duration({{.CacheTTL}})*time.Second)

    return resp, nil
  }

  func (s *{{.Name}}Service) runBusinessLogic({{range .Args}}{{LowerFirst .Name}} {{.Type}}, {{end}}) (resp {{.Resp.Type}}, err error) {
    // åŸä¸šåŠ¡é€»è¾‘
    return
  }

  func (s *{{.Name}}Service) buildCacheKey({{range .Args}}{{LowerFirst .Name}} {{.Type}}, {{end}}) string {
    key := "{{.ServiceName}}:{{.Name}}:"
    {{- range .Args}}
    key += fmt.Sprintf("%v:", {{LowerFirst .Name}})
    {{- end}}
    return key
  }
  {{- else}}
  // æ— ç¼“å­˜ç‰ˆæœ¬
  func (s *{{.Name}}Service) Run({{range .Args}}{{LowerFirst .Name}} {{.Type}}, {{end}}) (resp {{.Resp.Type}}, err error) {
    // ä¸šåŠ¡é€»è¾‘
    return
  }
  {{- end}}
  {{- end}}
}
```

### 7.3 æ¡ˆä¾‹ 3ï¼šç”Ÿæˆ DDD æ¶æ„çš„é¡¹ç›®

**éœ€æ±‚**ï¼šæŒ‰ç…§é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰ç»„ç»‡ä»£ç ç»“æ„

#### è§£å†³æ–¹æ¡ˆ

åˆ›å»ºæ–°çš„æ¨¡æ¿å¸ƒå±€ï¼š

```
tpl/kitex/server/ddd_layout/
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ domain.yaml          # é¢†åŸŸæ¨¡å‹
â”‚   â””â”€â”€ repository.yaml      # ä»“å‚¨æ¥å£
â”œâ”€â”€ application/
â”‚   â”œâ”€â”€ service.yaml         # åº”ç”¨æœåŠ¡
â”‚   â””â”€â”€ dto.yaml             # DTO
â”œâ”€â”€ infrastructure/
â”‚   â”œâ”€â”€ repository_impl.yaml # ä»“å‚¨å®ç°
â”‚   â””â”€â”€ dal_init.yaml        # æ•°æ®è®¿é—®å±‚
â””â”€â”€ interfaces/
    â”œâ”€â”€ handler.yaml         # å¤„ç†å™¨
    â””â”€â”€ assembler.yaml       # ç»„è£…å™¨
```

**ç¤ºä¾‹ - domain/repository.yaml**ï¼š

```yaml
path: domain/{{SnakeString .ServiceName}}/repository.go
body: |-
  package {{SnakeString .ServiceName}}

  import "context"

  // Repository ä»“å‚¨æ¥å£
  type Repository interface {
    {{range .Methods}}
    // {{.Name}} {{.Name}} æ–¹æ³•
    {{.Name}}(ctx context.Context, {{range .Args}}{{.Name}} {{.Type}}, {{end}}) ({{if .Void}}error{{else}}{{.Resp.Type}}, error{{end}})
    {{end}}
  }
```

**ç¤ºä¾‹ - application/service.yaml**ï¼š

```yaml
path: application/{{SnakeString .ServiceName}}/service.go
body: |-
  package {{SnakeString .ServiceName}}

  import (
    "context"
    "your-project/domain/{{SnakeString .ServiceName}}"
  )

  // Service åº”ç”¨æœåŠ¡
  type Service struct {
    repo repository.Repository
  }

  func NewService(repo repository.Repository) *Service {
    return &Service{repo: repo}
  }

  {{range .Methods}}
  func (s *Service) {{.Name}}(ctx context.Context, {{range .Args}}{{.Name}} {{.Type}}, {{end}}) ({{if .Void}}error{{else}}{{.Resp.Type}}, error{{end}}) {
    return s.repo.{{.Name}}(ctx, {{range .Args}}{{.Name}}, {{end}})
  }
  {{end}}
```

---

## å…«ã€å…³é”®æ–‡ä»¶é€ŸæŸ¥è¡¨

### 8.1 æ ¹æ®éœ€æ±‚æŸ¥æ‰¾æ–‡ä»¶

| å®šåˆ¶éœ€æ±‚ | éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶ | è¯´æ˜ |
|---------|---------------|------|
| **ä¿®æ”¹ Kitex æœåŠ¡ä»£ç ç»“æ„** | `tpl/kitex/server/standard/service.yaml` | ä¸šåŠ¡æœåŠ¡å±‚æ¨¡æ¿ |
| **ä¿®æ”¹ Hertz æœåŠ¡ä»£ç ç»“æ„** | `tpl/hertz/server/standard/layout.yaml` | é¡¹ç›®å¸ƒå±€æ¨¡æ¿ |
| **ä¿®æ”¹ Handler å®ç°** | `tpl/kitex/server/standard/handler_tpl.yaml` | Handler æ¨¡æ¿ |
| **ä¿®æ”¹ main.go å…¥å£** | `tpl/kitex/server/standard/main_tpl.yaml`<br>`tpl/hertz/server/standard/layout.yaml` | ä¸»ç¨‹åºå…¥å£ |
| **ä¿®æ”¹é…ç½®ç»“æ„** | `tpl/kitex/server/standard/conf_tpl.yaml` | é…ç½®æ–‡ä»¶æ¨¡æ¿ |
| **æ·»åŠ  CLI å‚æ•°** | `cmd/static/*_flags.go`<br>`config/*.go` | å‘½ä»¤è¡Œå‚æ•°å’Œé…ç½® |
| **ä¿®æ”¹ç”Ÿæˆé€»è¾‘** | `pkg/server/*.go`<br>`pkg/client/*.go`<br>`pkg/model/*.go` | ç”Ÿæˆé€»è¾‘å®ç° |
| **åˆ›å»ºæ–°æ¨¡æ¿å¸ƒå±€** | `tpl/kitex/server/your_layout/`<br>`tpl/hertz/server/your_layout/` | è‡ªå®šä¹‰æ¨¡æ¿ç›®å½• |
| **ä¿®æ”¹æ•°æ®åº“æ¨¡å‹ç”Ÿæˆ** | `pkg/model/model.go` | æ¨¡å‹ç”Ÿæˆé€»è¾‘ |
| **ä¿®æ”¹é…ç½®æ–‡ä»¶ç”Ÿæˆ** | `pkg/config_generator/*.go` | é…ç½®è½¬æ¢é€»è¾‘ |
| **æ·»åŠ æ–°çš„ç”Ÿæˆå‘½ä»¤** | `cmd/static/cmd.go`<br>`config/your_cmd.go`<br>`pkg/your_cmd/*.go` | æ–°å‘½ä»¤å®ç° |
| **ä¿®æ”¹æ¨¡æ¿å‡½æ•°** | `tpl/init.go` | æ³¨å†Œæ¨¡æ¿å‡½æ•° |
| **ä¿®æ”¹ä¸­é—´ä»¶** | `tpl/hertz/server/standard/layout.yaml` | åœ¨ registerMiddleware ä¸­æ·»åŠ  |

### 8.2 æ¨¡æ¿æ–‡ä»¶å¯¹ç…§è¡¨

#### Kitex æœåŠ¡å™¨æ¨¡æ¿

| æ¨¡æ¿æ–‡ä»¶ | ç”Ÿæˆæ–‡ä»¶ | ç”¨é€” |
|---------|---------|------|
| `main_tpl.yaml` | `main.go` | ä¸»ç¨‹åºå…¥å£ |
| `handler_tpl.yaml` | `biz/handler/*.go` | Handler å®ç° |
| `service.yaml` | `biz/service/*/*.go` | ä¸šåŠ¡é€»è¾‘å±‚ |
| `conf_tpl.yaml` | `conf/conf.go` | é…ç½®ç»“æ„ä½“ |
| `conf_dev_tpl.yaml` | `conf/config_dev.yaml` | å¼€å‘ç¯å¢ƒé…ç½® |
| `conf_test_tpl.yaml` | `conf/config_test.yaml` | æµ‹è¯•ç¯å¢ƒé…ç½® |
| `conf_online_tpl.yaml` | `conf/config_online.yaml` | ç”Ÿäº§ç¯å¢ƒé…ç½® |
| `dal_init.yaml` | `dal/init.go` | æ•°æ®è®¿é—®å±‚åˆå§‹åŒ– |
| `kitex_yaml.yaml` | `kitex.yaml` | Kitex å·¥å…·é…ç½® |
| `mysql.yaml` | `docker-compose.yml` | MySQL å®¹å™¨é…ç½® |
| `redis.yaml` | `docker-compose.yml` | Redis å®¹å™¨é…ç½® |
| `bootstrap_sh_tpl.yaml` | `bootstrap.sh` | å¯åŠ¨è„šæœ¬ |
| `build_sh_tpl.yaml` | `build.sh` | æ„å»ºè„šæœ¬ |
| `docker_compose.yaml` | `docker-compose.yml` | Docker ç¼–æ’æ–‡ä»¶ |
| `readme_tpl.yaml` | `README.md` | é¡¹ç›®æ–‡æ¡£ |
| `ignore_tpl.yaml` | `.gitignore` | Git å¿½ç•¥è§„åˆ™ |

#### Kitex å®¢æˆ·ç«¯æ¨¡æ¿

| æ¨¡æ¿æ–‡ä»¶ | ç”Ÿæˆæ–‡ä»¶ | ç”¨é€” |
|---------|---------|------|
| `client_tpl.yaml` | `client/rpc_client.go` | å®¢æˆ·ç«¯æ¥å£å®šä¹‰ |
| `default_tpl.yaml` | `client/default_rpc_client.go` | é»˜è®¤å®¢æˆ·ç«¯å®ç° |
| `init_tpl.yaml` | `client/init.go` | å®¢æˆ·ç«¯åˆå§‹åŒ– |

#### Hertz æœåŠ¡å™¨æ¨¡æ¿

| æ¨¡æ¿æ–‡ä»¶ | ç”Ÿæˆæ–‡ä»¶ | ç”¨é€” |
|---------|---------|------|
| `layout.yaml` | å¤šä¸ªæ–‡ä»¶ | æ•´ä¸ªé¡¹ç›®å¸ƒå±€ |
| `package.yaml` | - | åŒ…ä¿¡æ¯é…ç½® |

### 8.3 ä»£ç ç”Ÿæˆæ¨¡å—å¯¹ç…§è¡¨

| æ¨¡å— | å…¥å£æ–‡ä»¶ | æ ¸å¿ƒæ–‡ä»¶ | åŠŸèƒ½ |
|------|---------|---------|------|
| **Server** | `pkg/server/server.go` | `pkg/server/kitex.go`<br>`pkg/server/hz.go` | ç”ŸæˆæœåŠ¡ç«¯ä»£ç  |
| **Client** | `pkg/client/client.go` | `pkg/client/kitex.go`<br>`pkg/client/hz.go` | ç”Ÿæˆå®¢æˆ·ç«¯ä»£ç  |
| **Model** | `pkg/model/model.go` | `pkg/model/check.go` | ç”Ÿæˆæ•°æ®åº“æ¨¡å‹ |
| **Doc** | `pkg/curd/doc/doc.go` | `pkg/curd/doc/mongo/` | ç”Ÿæˆ MongoDB ä»£ç  |
| **Config** | `pkg/config_generator/sdk.go` | `pkg/config_generator/yaml2go.go` | é…ç½®è½¬ä»£ç  |
| **API List** | `pkg/api_list/api_list.go` | `pkg/api_list/parser/` | è·¯ç”±åˆ†æ |

---

## ä¹ã€å¼€å‘å·¥ä½œæµ

### 9.1 æ¨èçš„å®šåˆ¶åŒ–å¼€å‘æµç¨‹

```
1. éœ€æ±‚åˆ†æ
   â†“
2. ç¡®å®šè¦ä¿®æ”¹çš„æ–‡ä»¶
   â†“
3. å¤‡ä»½åŸå§‹æ¨¡æ¿
   â†“
4. ä¿®æ”¹æ¨¡æ¿æ–‡ä»¶
   â†“
5. æœ¬åœ°æµ‹è¯•
   â†“
6. æ„å»ºå’ŒéªŒè¯
   â†“
7. æäº¤ä»£ç 
```

### 9.2 æœ¬åœ°æµ‹è¯•æµç¨‹

```bash
# 1. ä¿®æ”¹æ¨¡æ¿æ–‡ä»¶
vim tpl/kitex/server/standard/service.yaml

# 2. æ„å»ºå·¥å…·
go build -o cwgo cwgo.go

# 3. æµ‹è¯•ç”Ÿæˆä»£ç 
./cwgo server -type rpc \
  -module test-project \
  -service test.service \
  -idl idl/test.thrift \
  -out-dir /tmp/test_output

# 4. æ£€æŸ¥ç”Ÿæˆçš„ä»£ç 
ls -la /tmp/test_output
cat /tmp/test_output/biz/service/testservice/method.go

# 5. å°è¯•ç¼–è¯‘ç”Ÿæˆçš„ä»£ç 
cd /tmp/test_output
go mod tidy
go build
```

### 9.3 è°ƒè¯•æŠ€å·§

#### 1. æŸ¥çœ‹æ¸²æŸ“åçš„æ¨¡æ¿

åœ¨æ¨¡æ¿ä¸­æ·»åŠ æ³¨é‡Šï¼š

```yaml
body: |-
  // DEBUG: ServiceName = {{.ServiceName}}
  // DEBUG: Method = {{.Name}}
  package {{SnakeString .ServiceName}}
  // ...
```

#### 2. ä½¿ç”¨è¯¦ç»†æ¨¡å¼

```bash
./cwgo server -vv -type rpc ...
```

#### 3. æ£€æŸ¥ä¸­é—´äº§ç‰©

```bash
# æŸ¥çœ‹ä¸´æ—¶ç›®å½•ä¸­çš„æ¨¡æ¿
ls -la $TMPDIR/kitex/
```

### 9.4 å¸¸è§é—®é¢˜

#### Q1: æ¨¡æ¿å˜é‡ä¸ç”Ÿæ•ˆ

**åŸå› **ï¼šæ¨¡æ¿å˜é‡åç§°é”™è¯¯æˆ–æœªä¼ é€’

**è§£å†³**ï¼š
1. æ£€æŸ¥å˜é‡åæ˜¯å¦æ­£ç¡®ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰
2. ç¡®è®¤å˜é‡åœ¨ç”Ÿæˆé€»è¾‘ä¸­å·²è®¾ç½®
3. ä½¿ç”¨è¯¦ç»†æ¨¡å¼æŸ¥çœ‹é”™è¯¯ä¿¡æ¯

#### Q2: ç”Ÿæˆçš„ä»£ç ç¼–è¯‘å¤±è´¥

**åŸå› **ï¼šæ¨¡æ¿è¯­æ³•é”™è¯¯æˆ–å¯¼å…¥è·¯å¾„é”™è¯¯

**è§£å†³**ï¼š
1. æ£€æŸ¥æ¨¡æ¿çš„ YAML è¯­æ³•
2. éªŒè¯ import è¯­å¥çš„æ­£ç¡®æ€§
3. ç¡®ä¿æ‰€æœ‰å¿…è¦çš„åŒ…éƒ½å·²å¯¼å…¥

#### Q3: å¦‚ä½•æ·»åŠ æ¡ä»¶æ¸²æŸ“

**æ–¹æ³•**ï¼šä½¿ç”¨ Go template çš„ if è¯­å¥

```yaml
{{if .EnableCache}}
import "github.com/go-redis/redis/v8"
{{end}}

type Service struct {
    {{if .EnableCache}}
    redis *redis.Client
    {{end}}
}
```

#### Q4: å¦‚ä½•å¾ªç¯ç”Ÿæˆä»£ç 

**æ–¹æ³•**ï¼šä½¿ç”¨ Go template çš„ range è¯­å¥

```yaml
{{range .Methods}}
func (s *Service) {{.Name}}({{range .Args}}{{.Name}} {{.Type}}, {{end}}) {
    // æ–¹æ³•å®ç°
}
{{end}}
```

---

## åã€æœ€ä½³å®è·µ

### 10.1 æ¨¡æ¿è®¾è®¡åŸåˆ™

1. **ä¿æŒç®€å•**ï¼šé¿å…åœ¨æ¨¡æ¿ä¸­ç¼–å†™å¤æ‚é€»è¾‘
2. **å¯è¯»æ€§ä¼˜å…ˆ**ï¼šç”Ÿæˆæ¸…æ™°ã€æ˜“è¯»çš„ä»£ç 
3. **éµå¾ªè§„èŒƒ**ï¼šç¬¦åˆ Go è¯­è¨€è§„èŒƒå’Œé¡¹ç›®è§„èŒƒ
4. **æ˜“äºç»´æŠ¤**ï¼šæ·»åŠ æ³¨é‡Šè¯´æ˜ç”Ÿæˆä»£ç çš„ç”¨é€”

### 10.2 å®šåˆ¶åŒ–å»ºè®®

1. **æ¸è¿›å¼ä¿®æ”¹**ï¼šä¸€æ¬¡åªä¿®æ”¹ä¸€ä¸ªåŠŸèƒ½ï¼Œæµ‹è¯•é€šè¿‡åå†ç»§ç»­
2. **ç‰ˆæœ¬æ§åˆ¶**ï¼šä½¿ç”¨ Git ç®¡ç†å®šåˆ¶åŒ–åˆ†æ”¯
3. **æ–‡æ¡£è®°å½•**ï¼šè®°å½•ä¿®æ”¹çš„åŸå› å’Œæ•ˆæœ
4. **å……åˆ†æµ‹è¯•**ï¼šéªŒè¯å„ç§åœºæ™¯ä¸‹çš„ä»£ç ç”Ÿæˆ

### 10.3 ä»£ç ç”Ÿæˆè§„èŒƒ

```yaml
# è‰¯å¥½çš„æ¨¡æ¿ç¤ºä¾‹
body: |-
  // Code generated by cwgo. DO NOT EDIT.
  // Service: {{.ServiceName}}
  // Method: {{.Name}}
  // Generated at: {{now}}

  package service

  import (
    "context"
  )

  // {{.Name}}Service handles {{.Name}} business logic
  type {{.Name}}Service struct {
    ctx context.Context
  }

  // New{{.Name}}Service creates a new {{.Name}}Service
  func New{{.Name}}Service(ctx context.Context) *{{.Name}}Service {
    return &{{.Name}}Service{ctx: ctx}
  }

  // Run executes the {{.Name}} business logic
  func (s *{{.Name}}Service) Run({{range .Args}}{{.Name}} {{.Type}}, {{end}}) error {
    // TODO: Implement your business logic here
    return nil
  }
```

### 10.4 å›¢é˜Ÿåä½œ

1. **ç»Ÿä¸€æ¨¡æ¿**ï¼šå›¢é˜Ÿä½¿ç”¨ç»Ÿä¸€çš„æ¨¡æ¿ç‰ˆæœ¬
2. **ä»£ç å®¡æŸ¥**ï¼šæ¨¡æ¿ä¿®æ”¹éœ€è¦ä»£ç å®¡æŸ¥
3. **æ–‡æ¡£å…±äº«**ï¼šç»´æŠ¤å®šåˆ¶åŒ–æ–‡æ¡£
4. **å®šæœŸåŒæ­¥**ï¼šä¸ä¸Šæ¸¸é¡¹ç›®ä¿æŒåŒæ­¥

---

## åä¸€ã€é™„å½•

### 11.1 å®Œæ•´çš„æ¨¡æ¿å˜é‡åˆ—è¡¨

```go
// æœåŠ¡ç›¸å…³
.ServiceName        string  // æœåŠ¡åç§°
.Type              string  // æœåŠ¡ç±»å‹ï¼ˆRPC/HTTPï¼‰
.GoModule          string  // Go æ¨¡å—å
.IdlPath           string  // IDL æ–‡ä»¶è·¯å¾„
.OutDir            string  // è¾“å‡ºç›®å½•

// æ–¹æ³•ç›¸å…³
.Methods           []Method // æ‰€æœ‰æ–¹æ³•
.Name              string   // å½“å‰æ–¹æ³•å
.Args              []Arg    // æ–¹æ³•å‚æ•°
.Resp              Response // è¿”å›å€¼
.Void              bool     // æ˜¯å¦æ— è¿”å›å€¼
.Oneway            bool     // æ˜¯å¦å•å‘è°ƒç”¨
.ClientStreaming   bool     // æ˜¯å¦å®¢æˆ·ç«¯æµ
.ServerStreaming   bool     // æ˜¯å¦æœåŠ¡ç«¯æµ

// é…ç½®ç›¸å…³
.Registry          string   // æ³¨å†Œä¸­å¿ƒç±»å‹
.Template          string   // æ¨¡æ¿è·¯å¾„
.Verbose           bool     // è¯¦ç»†æ¨¡å¼

// è‡ªå®šä¹‰é…ç½®ï¼ˆéœ€è¦æ·»åŠ ï¼‰
.EnableCache       bool
.CacheType         string
.EnableTracing     bool
// ... æ›´å¤šè‡ªå®šä¹‰å­—æ®µ
```

### 11.2 å¸¸ç”¨æ¨¡æ¿å‡½æ•°é€ŸæŸ¥

```go
// å­—ç¬¦ä¸²å¤„ç†
{{ toLower "String" }}        // "string"
{{ toUpper "String" }}        // "STRING"
{{ title "string" }}          // "String"
{{ snakeCase "String" }}      // "string"
{{ camelCase "string_name" }} // "stringName"
{{ kebabCase "StringName" }}  // "string-name"

// å­—ç¬¦ä¸²æ“ä½œ
{{ trim "  hello  " }}        // "hello"
{{ split "a,b,c" "," }}       // ["a", "b", "c"]
{{ join ["a","b"] "," }}      // "a,b"

// åˆ—è¡¨æ“ä½œ
{{ list "a" "b" "c" }}        // ["a", "b", "c"]
{{ first ["a","b"] }}         // "a"
{{ last ["a","b"] }}          // "b"
{{ slice ["a","b","c"] 1 2 }} // ["b"]

// æ•°å­¦è¿ç®—
{{ add 1 2 }}                 // 3
{{ sub 3 1 }}                 // 2
{{ mul 2 3 }}                 // 6
{{ div 6 2 }}                 // 3

// é»˜è®¤å€¼
{{ default "default" .Value }} // å¦‚æœ Value ä¸ºç©ºåˆ™ä½¿ç”¨ "default"

// æ¡ä»¶åˆ¤æ–­
{{ if .Enable }}enabled{{end}}
{{ if eq .Type "rpc" }}RPC{{else}}HTTP{{end}}

// å¾ªç¯
{{ range .Methods }}
  Method: {{.Name}}
{{ end }}

// è‡ªå®šä¹‰å‡½æ•°
{{ ToCamel "string_name" }}   // "StringName"
{{ SnakeString "StringName" }} // "string_name"
{{ LowerFirst "String" }}      // "string"
```

### 11.3 æ›´æ–°è¡Œä¸ºè¯´æ˜

```yaml
update_behavior:
  type: skip    # è·³è¿‡å·²å­˜åœ¨çš„æ–‡ä»¶
  type: cover   # è¦†ç›–å·²å­˜åœ¨çš„æ–‡ä»¶
  type: append  # è¿½åŠ åˆ°å·²å­˜åœ¨çš„æ–‡ä»¶
```

### 11.4 èµ„æºé“¾æ¥

- [CloudWeGo å®˜æ–¹æ–‡æ¡£](https://www.cloudwego.io/)
- [Kitex æ–‡æ¡£](https://www.cloudwego.io/docs/kitex/)
- [Hertz æ–‡æ¡£](https://www.cloudwego.io/docs/hertz/)
- [Go Template æ–‡æ¡£](https://pkg.go.dev/text/template)
- [Sprig å‡½æ•°åº“](https://masterminds.github.io/sprig/)
- [GORM æ–‡æ¡£](https://gorm.io/docs/)

---

## åäºŒã€cwgo ä¸ Eino æ¡†æ¶é›†æˆåˆ†æ

> æœ¬ç« è¯¦ç»†åˆ†æ cwgo å¦‚ä½•é›†æˆ CloudWeGo Eino AI åº”ç”¨å¼€å‘æ¡†æ¶ã€‚

### 12.1 Eino æ¡†æ¶ç®€ä»‹

#### 12.1.1 ä»€ä¹ˆæ˜¯ Eino

**Eino**ï¼ˆå‘éŸ³ç±»ä¼¼ "I know"ï¼‰æ˜¯ CloudWeGo ç”Ÿæ€ç³»ç»Ÿä¸­ä¸“æ³¨äº AI åº”ç”¨å¼€å‘çš„ Go æ¡†æ¶ã€‚å®ƒå€Ÿé‰´äº† LangChain å’Œ LlamaIndex ç­‰ä¼˜ç§€æ¡†æ¶çš„è®¾è®¡ç†å¿µï¼Œä¸ºæ„å»ºä¼ä¸šçº§å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰åº”ç”¨æä¾›äº†å¼ºå¤§çš„åŸºç¡€è®¾æ–½ã€‚

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- ğŸš€ **ç®€å•æ€§**ï¼šæ¸…æ™°çš„ API è®¾è®¡ï¼Œæ˜“äºä¸Šæ‰‹
- ğŸ”§ **å¯æ‰©å±•æ€§**ï¼šæ¨¡å—åŒ–ç»„ä»¶è®¾è®¡ï¼Œçµæ´»ç»„åˆ
- ğŸ›¡ï¸ **ç±»å‹å®‰å…¨**ï¼šå¼ºç±»å‹æ£€æŸ¥ï¼Œç¼–è¯‘æ—¶å‘ç°é”™è¯¯
- ğŸŒŠ **æµå¼æ”¯æŒ**ï¼šå®Œæ•´çš„æµå¤„ç†èƒ½åŠ›
- ğŸ­ **ç”Ÿäº§å°±ç»ª**ï¼šä¼ä¸šçº§å¯é æ€§å’Œæ€§èƒ½

#### 12.1.2 Eino æ ¸å¿ƒèƒ½åŠ›

Eino æä¾›ä¸‰å±‚æ ¸å¿ƒèƒ½åŠ›ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Flows & Agents                         â”‚
â”‚  (é¢„ç½®çš„ AI åº”ç”¨æ¨¡å¼ï¼šReAct Agent, Multi-Agent ç­‰)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–²
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Composition Framework                       â”‚
â”‚     (ç¼–æ’æ¡†æ¶ï¼šChain, Graph, Workflow)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–²
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Components Layer                        â”‚
â”‚  (ç»„ä»¶ï¼šChatModel, Tool, Retriever, Embedding ç­‰)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**1. ç»„ä»¶å±‚ï¼ˆComponentsï¼‰**

| ç»„ä»¶ç±»å‹ | åŠŸèƒ½æè¿° | å…¸å‹å®ç° |
|---------|---------|---------|
| **ChatModel** | å¤§è¯­è¨€æ¨¡å‹æ¥å£ | OpenAI, Claude, Gemini, Qwen, DeepSeek |
| **Tool** | Agent å¯è°ƒç”¨çš„å·¥å…· | HTTP Request, Web Search, Calculator |
| **ChatTemplate** | Prompt æ¨¡æ¿ç®¡ç† | æ¶ˆæ¯æ ¼å¼åŒ–ã€å˜é‡æ›¿æ¢ |
| **Retriever** | ä¿¡æ¯æ£€ç´¢ | RAG æ£€ç´¢ã€å‘é‡æœç´¢ |
| **Embedding** | æ–‡æœ¬å‘é‡åŒ– | OpenAI Embedding, DashScope |
| **Indexer** | æ–‡æ¡£ç´¢å¼•ç®¡ç† | ES8, Milvus, Redis |

**2. ç¼–æ’å±‚ï¼ˆCompositionï¼‰**

| ç¼–æ’æ–¹å¼ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|---------|------|---------|
| **Chain** | ç®€å•çš„çº¿æ€§æœ‰å‘å›¾ | ç®€å•çš„ LLM åº”ç”¨ |
| **Graph** | æ”¯æŒå¾ªç¯çš„æœ‰å‘å›¾ | å¤æ‚çš„ Agent åº”ç”¨ |
| **Workflow** | å­—æ®µçº§æ•°æ®æ˜ å°„ | éœ€è¦ç²¾ç»†æ§åˆ¶çš„åœºæ™¯ |

**3. é¢„ç½®æµç¨‹ï¼ˆFlows & Agentsï¼‰**

- **ReAct Agent**ï¼šæ¨ç†+è¡ŒåŠ¨çš„æ™ºèƒ½ä½“æ¨¡å¼
- **Multi-Agent**ï¼šå¤šæ™ºèƒ½ä½“åä½œ
- **RAG Flow**ï¼šæ£€ç´¢å¢å¼ºç”Ÿæˆ

#### 12.1.3 âš ï¸ å…³é”®ç†è§£ï¼šEino çš„è¾¹ç•Œ

**éå¸¸é‡è¦**ï¼šEino **ä¸æä¾›** HTTP/RPC é€šä¿¡èƒ½åŠ›ï¼

```
Eino çš„èƒ½åŠ›è¾¹ç•Œï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Eino æ¡†æ¶                  â”‚
â”‚  âœ… ChatModelï¼ˆLLM è°ƒç”¨ï¼‰          â”‚
â”‚  âœ… Toolï¼ˆå·¥å…·å®šä¹‰ï¼‰                â”‚
â”‚  âœ… Retrieverï¼ˆæ£€ç´¢ï¼‰               â”‚
â”‚  âœ… Agent/Chain/Graphï¼ˆç¼–æ’ï¼‰      â”‚
â”‚  âœ… Callbackï¼ˆå›è°ƒï¼‰                â”‚
â”‚                                    â”‚
â”‚  âŒ HTTP Server                    â”‚
â”‚  âŒ RPC Server                     â”‚
â”‚  âŒ ç½‘ç»œé€šä¿¡                        â”‚
â”‚  âŒ æœåŠ¡å‘ç°                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¿™æ„å‘³ç€**ï¼šEino å¿…é¡»ä¾èµ–æŸä¸ªé€šä¿¡æ¡†æ¶å¯¹å¤–æä¾›æœåŠ¡ï¼Œå¦‚ Hertz (HTTP) æˆ– Kitex (RPC)ã€‚

---

### 12.2 é›†æˆæ¶æ„è®¾è®¡

#### 12.2.1 æ ¸å¿ƒç†å¿µ

**Eino ä½œä¸ºä¸šåŠ¡é€»è¾‘ç»„ä»¶ï¼Œé›†æˆåˆ° Kitex/Hertz æœåŠ¡ä¸­ã€‚**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Kitex/Hertz æœåŠ¡                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Handler Layer (æ¥å£å±‚)             â”‚  â”‚
â”‚  â”‚  - è§£æ HTTP/RPC è¯·æ±‚              â”‚  â”‚
â”‚  â”‚  - å‚æ•°éªŒè¯                        â”‚  â”‚
â”‚  â”‚  - å“åº”åºåˆ—åŒ–                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                 â†“                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Service Layer (ä¸šåŠ¡é€»è¾‘å±‚)         â”‚  â”‚
â”‚  â”‚                                    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ ä¼ ç»Ÿä¸šåŠ¡é€»è¾‘                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - æ•°æ®åº“ CRUD                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - ä¸šåŠ¡è§„åˆ™                    â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ Eino Agent (AI èƒ½åŠ›)          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - æ™ºèƒ½æ¨è                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - å¯¹è¯ç®¡ç†                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - å¤æ‚æ¨ç†                    â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                 â†“                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Data Access Layer                 â”‚  â”‚
â”‚  â”‚  - æ•°æ®åº“                          â”‚  â”‚
â”‚  â”‚  - ç¼“å­˜                            â”‚  â”‚
â”‚  â”‚  - å¤–éƒ¨æœåŠ¡                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘                                  â†‘
    å¤–éƒ¨è°ƒç”¨                          æ•°æ®å­˜å‚¨
```

#### 12.2.2 ä¸ºä»€ä¹ˆä¸ç‹¬ç«‹éƒ¨ç½² AI æœåŠ¡ï¼Ÿ

**åå¯¹"ç‹¬ç«‹ AI æœåŠ¡"çš„ç†ç”±**ï¼š

1. **Eino æœ¬èº«æ— æ³•ç‹¬ç«‹æä¾›æœåŠ¡**
   - âŒ æ²¡æœ‰ HTTP Server èƒ½åŠ›
   - âŒ æ²¡æœ‰ RPC Server èƒ½åŠ›
   - âœ… å¿…é¡»ä¾èµ– Hertz/Kitex
   - â†’ å³ä½¿"ç‹¬ç«‹æœåŠ¡"ä¹Ÿéœ€è¦åµŒå…¥é€šä¿¡æ¡†æ¶

2. **é‡å¤çš„é€šä¿¡å±‚**
   ```
   âŒ é”™è¯¯æ¶æ„ï¼ˆç‹¬ç«‹æœåŠ¡ï¼‰ï¼š
   Client â†’ Kitex Server â†’ HTTP â†’ "AI Service" (Hertz) â†’ LLM
          (RPC)           (é‡å¤é€šä¿¡)

   âœ… æ­£ç¡®æ¶æ„ï¼ˆé›†æˆï¼‰ï¼š
   Client â†’ Kitex Server â†’ ä¸šåŠ¡é€»è¾‘(å« Eino) â†’ LLM
          (RPC)           (è¿›ç¨‹å†…è°ƒç”¨)
   ```

3. **è¿åç®€æ´æ€§åŸåˆ™**
   - Go çš„å“²å­¦ï¼šç®€å•ä¼˜äºå¤æ‚
   - è¿‡æ—©æ‹†åˆ†æœåŠ¡ä¼šå¢åŠ ç»´æŠ¤æˆæœ¬
   - å¾®æœåŠ¡åº”è¯¥æ˜¯æ¼”è¿›çš„ç»“æœï¼Œè€Œéèµ·ç‚¹

#### 12.2.3 ä¸‰ç§ä½¿ç”¨æ¨¡å¼

æ ¹æ® AI åœ¨ä¸šåŠ¡ä¸­çš„æ¯”é‡ï¼Œcwgo æ”¯æŒä¸‰ç§ç”Ÿæˆæ¨¡å¼ï¼š

**æ¨¡å¼ 1ï¼šä¼ ç»ŸæœåŠ¡ï¼ˆæ—  AIï¼‰**

```bash
cwgo server -type rpc -service user
```

ç”Ÿæˆï¼š
```
user-service/
â”œâ”€â”€ main.go
â”œâ”€â”€ biz/
â”‚   â””â”€â”€ service/
â”‚       â””â”€â”€ get_user.go        # ä¼ ç»Ÿ CRUD
â””â”€â”€ kitex_gen/
```

**æ¨¡å¼ 2ï¼šAI å¢å¼ºæœåŠ¡ï¼ˆä¼ ç»Ÿé€»è¾‘ + AIï¼‰**

```bash
cwgo server -type rpc -service user -enable-eino
```

ç”Ÿæˆï¼š
```
user-service/
â”œâ”€â”€ main.go
â”œâ”€â”€ biz/
â”‚   â””â”€â”€ service/
â”‚       â”œâ”€â”€ get_user.go            # ä¼ ç»Ÿ CRUD
â”‚       â””â”€â”€ recommend_users.go     # ä½¿ç”¨ Agent æ¨è
â””â”€â”€ internal/
    â””â”€â”€ agent/
        â””â”€â”€ agent.go               # Eino Agent
```

**æ¨¡å¼ 3ï¼šAI ä¸»å¯¼æœåŠ¡ï¼ˆä¸»è¦æ˜¯ AI èƒ½åŠ›ï¼‰**

```bash
cwgo server -type http -service chatbot -enable-eino -eino-mode agent-only
```

ç”Ÿæˆï¼š
```
chatbot/
â”œâ”€â”€ main.go                          # Hertz HTTP Server
â”œâ”€â”€ biz/
â”‚   â””â”€â”€ handler/
â”‚       â””â”€â”€ chat.go                 # HTTP æ¥å£
â””â”€â”€ internal/
    â””â”€â”€ agent/
        â”œâ”€â”€ agent.go                # Eino Agentï¼ˆæ ¸å¿ƒï¼‰
        â”œâ”€â”€ tools.go                # å·¥å…·å®šä¹‰
        â””â”€â”€ retriever.go            # RAG æ£€ç´¢
```

**æ³¨æ„**ï¼šå³ä½¿æ˜¯"AI ä¸»å¯¼æœåŠ¡"ï¼Œå®ƒçš„ `main.go` ä¾ç„¶æ˜¯å¯åŠ¨ Hertz Serverï¼

---

### 12.3 é›†æˆå®ç°æ–¹æ¡ˆ

#### 12.3.1 æ‰©å±•ç°æœ‰æ¨¡æ¿ï¼ˆæ¨èï¼‰

ä¸åˆ›å»ºæ–°çš„ `pkg/agent` æ¨¡å—ï¼Œè€Œæ˜¯åœ¨ç°æœ‰æ¨¡æ¿ä¸­æ·»åŠ  Eino æ”¯æŒã€‚

**ä¿®æ”¹ 1ï¼šæ‰©å±•é…ç½®ç»“æ„**

**æ–‡ä»¶**ï¼š`config/server.go`

```go
type ServerArgument struct {
    *CommonParam

    // ç°æœ‰å­—æ®µ...
    Template   string
    Branch     string
    Verbose    bool

    // Eino é›†æˆé…ç½®
    EnableEino      bool    // æ˜¯å¦å¯ç”¨ Eino
    EinoMode        string  // eino æ¨¡å¼ï¼šenhanced(å¢å¼º) / agent-only(çº¯ AI)
    AgentType       string  // Agent ç±»å‹ï¼šreact / multi-agent / rag
    ModelProvider   string  // LLM æä¾›å•†ï¼šopenai / claude / qwen
    ModelName       string  // æ¨¡å‹åç§°ï¼šgpt-4 / claude-3
    EnableTools     []string // å¯ç”¨çš„å·¥å…·ï¼šsearch / calculator / custom
    EnableRAG       bool    // æ˜¯å¦å¯ç”¨ RAG
}
```

**ä¿®æ”¹ 2ï¼šæ·»åŠ å‘½ä»¤è¡Œå‚æ•°**

**æ–‡ä»¶**ï¼š`cmd/static/server_flags.go`

```go
func serverFlags() []cli.Flag {
    return []cli.Flag{
        // ç°æœ‰æ ‡å¿—...

        // Eino é›†æˆæ ‡å¿—
        &cli.BoolFlag{
            Name:  "enable-eino",
            Usage: "Enable Eino AI capabilities in generated service",
            Value: false,
        },
        &cli.StringFlag{
            Name:  "eino-mode",
            Usage: "Eino integration mode: enhanced (AI + traditional) or agent-only (AI only)",
            Value: "enhanced",
        },
        &cli.StringFlag{
            Name:  "agent-type",
            Usage: "Agent type: react, multi-agent, rag",
            Value: "react",
        },
        &cli.StringFlag{
            Name:  "model-provider",
            Usage: "LLM provider: openai, claude, qwen",
            Value: "openai",
        },
        &cli.StringFlag{
            Name:  "model-name",
            Usage: "Model name: gpt-4, claude-3-sonnet, qwen-max",
            Value: "gpt-4",
        },
        &cli.StringSliceFlag{
            Name:  "enable-tools",
            Usage: "Enable tools: search, calculator, http",
            Value: []string{},
        },
        &cli.BoolFlag{
            Name:  "enable-rag",
            Usage: "Enable RAG (Retrieval Augmented Generation)",
            Value: false,
        },
    }
}
```

#### 12.3.2 æ‰©å±• Service æ¨¡æ¿

**ä¿®æ”¹æ–‡ä»¶**ï¼š`pkg/server/server.go`

```go
func Server(c *config.ServerArgument) error {
    err := check(c)
    if err != nil {
        return err
    }

    // å¦‚æœå¯ç”¨ Einoï¼Œå…ˆç”Ÿæˆ Agent æ¨¡å—
    if c.EnableEino {
        if err := generateEinoAgentModule(c); err != nil {
            return err
        }
    }

    switch c.Type {
    case consts.RPC:
        // ç°æœ‰ Kitex ç”Ÿæˆé€»è¾‘...
    case consts.HTTP:
        // ç°æœ‰ Hertz ç”Ÿæˆé€»è¾‘...
    }

    return nil
}

func generateEinoAgentModule(c *config.ServerArgument) error {
    // 1. åˆ›å»º internal/agent ç›®å½•
    agentDir := path.Join(c.OutDir, "internal", "agent")
    os.MkdirAll(agentDir, 0o755)

    // 2. æ ¹æ®ç±»å‹ç”Ÿæˆ Agent ä»£ç 
    switch c.AgentType {
    case "react":
        return generateReActAgent(c, agentDir)
    case "rag":
        return generateRAGAgent(c, agentDir)
    case "multi-agent":
        return generateMultiAgent(c, agentDir)
    default:
        return generateCustomAgent(c, agentDir)
    }
}
```

#### 12.3.3 åˆ›å»º Eino æ¨¡æ¿

**æ–‡ä»¶**ï¼š`tpl/eino/agent/react_agent.go`ï¼ˆä¸æ˜¯ YAMLï¼Œè€Œæ˜¯ Go æ¨¡æ¿ï¼‰

```go
package eino

import (
    "bytes"
    "text/template"
    "github.com/cloudwego/cwgo/config"
)

type AgentTemplateData struct {
    GoModule      string
    AgentName     string
    ModelProvider string
    ModelName     string
    Tools         []string
    EnableRAG     bool
}

func GenerateReActAgent(c *config.ServerArgument, outDir string) error {
    data := AgentTemplateData{
        GoModule:      c.GoMod,
        AgentName:     c.ServiceName + "Agent",
        ModelProvider: c.ModelProvider,
        ModelName:     c.ModelName,
        Tools:         c.EnableTools,
        EnableRAG:     c.EnableRAG,
    }

    tmpl := `package agent

import (
    "context"
    "github.com/cloudwego/eino/flow/agent/react"
    "github.com/cloudwego/eino/components/model"
    "github.com/cloudwego/eino/components/tool"
    einoModel "{{.GoModule}}/internal/eino/model"
    "{{.GoModule}}/internal/eino/tools"
)

type {{.AgentName}} struct {
    agent *react.Agent
}

func New{{.AgentName}}(ctx context.Context) (*{{.AgentName}}, error) {
    // 1. åˆå§‹åŒ– ChatModel
    chatModel, err := einoModel.NewChatModel(ctx, "{{.ModelProvider}}", "{{.ModelName}}")
    if err != nil {
        return nil, err
    }

    // 2. åˆå§‹åŒ– Tools
    var toolList []tool.Tool
    {{range .Tools}}
    toolList = append(toolList, tools.New{{.}}Tool())
    {{end}}

    toolsNode, err := react.NewToolsNode(ctx, toolList...)
    if err != nil {
        return nil, err
    }

    // 3. åˆ›å»º ReAct Agent
    agent, err := react.NewAgent(ctx, []react.AgentOption{
        react.WithChatModel(chatModel),
        react.WithTools(toolsNode),
        react.WithMaxLoops(10),
    })
    if err != nil {
        return nil, err
    }

    return &{{.AgentName}}{agent: agent}, nil
}

func (a *{{.AgentName}}) Run(ctx context.Context, query string) (string, error) {
    result, err := a.agent.Run(ctx, query)
    if err != nil {
        return "", err
    }
    return result, nil
}
`

    // æ¸²æŸ“æ¨¡æ¿
    t := template.Must(template.New("agent").Parse(tmpl))
    var buf bytes.Buffer
    if err := t.Execute(&buf, data); err != nil {
        return err
    }

    // å†™å…¥æ–‡ä»¶
    return writeFile(outDir, "agent.go", buf.Bytes())
}
```

#### 12.3.4 æ‰©å±• Service æ¨¡æ¿

**ä¿®æ”¹æ–‡ä»¶**ï¼š`tpl/kitex/server/standard/service.yaml`

```yaml
path: biz/service/{{SnakeString .ServiceName}}/{{ SnakeString (index .Methods 0).Name }}.go
loop_method: true
update_behavior:
  type: skip
body: |-
  package {{SnakeString .ServiceName}}

  import (
    "context"

    {{- if .EnableEino }}
    "{{.GoModule}}/internal/agent"
    {{- end}}

    {{- /* ä¿ç•™åŠ¨æ€å¯¼å…¥ */}}
    {{- range $path, $aliases := ( FilterImports .Imports .Methods )}}
    ...
    {{- end}}
  )

  {{range .Methods}}

  type {{.Name}}Service struct {
    ctx context.Context
    db  *gorm.DB
    {{- if .EnableEino }}
    agent *agent.{{.ServiceName}}Agent
    {{- end}}
  }

  func New{{.Name}}Service(ctx context.Context{{if .EnableEino}}, agent *agent.{{.ServiceName}}Agent{{end}}, db *gorm.DB) *{{.Name}}Service {
    return &{{.Name}}Service{
      ctx: ctx{{if .EnableEino}},
      agent: agent{{end}},
      db:  db,
    }
  }

  func (s *{{.Name}}Service) Run({{range .Args}}{{LowerFirst .Name}} {{.Type}}, {{end}}) (resp {{.Resp.Type}}, err error) {
    {{- if .EnableEino }}
    // ä½¿ç”¨ AI Agent å¤„ç†
    result, err := s.agent.Run(s.ctx, {{range .Args}}{{.Name}}, {{end}})
    if err != nil {
      return nil, err
    }
    return s.convertAIResult(result)
    {{- else}}
    // ä¼ ç»Ÿä¸šåŠ¡é€»è¾‘
    return s.db.Query({{range .Args}}{{.Name}}, {{end}})
    {{- end}}
  }
  {{end}}
```

---

### 12.4 å®æˆ˜æ¡ˆä¾‹ï¼šæ™ºèƒ½æ¨èæœåŠ¡

#### 12.4.1 éœ€æ±‚æè¿°

ç”Ÿæˆä¸€ä¸ªç”¨æˆ·æ¨èæœåŠ¡ï¼Œå…·å¤‡ï¼š
1. ä¼ ç»Ÿ CRUD åŠŸèƒ½ï¼ˆç”¨æˆ·æŸ¥è¯¢ï¼‰
2. AI æ™ºèƒ½æ¨èï¼ˆåŸºäºç”¨æˆ·ç”»åƒï¼‰
3. HTTP API æ¥å£

#### 12.4.2 ç”Ÿæˆå‘½ä»¤

```bash
# ç”Ÿæˆå¸¦ AI èƒ½åŠ›çš„ Hertz æœåŠ¡
cwgo server -type http \
  -service user.recommendation \
  -module github.com/company/user-recommendation \
  -idl idl/user.thrift \
  -enable-eino \
  -agent-type rag \
  -enable-tools search,database \
  -enable-rag \
  -out-dir ./user-recommendation
```

#### 12.4.3 ç”Ÿæˆçš„é¡¹ç›®ç»“æ„

```
user-recommendation/
â”œâ”€â”€ main.go                          # Hertz Server å…¥å£
â”œâ”€â”€ go.mod
â”œâ”€â”€ conf/
â”‚   â”œâ”€â”€ conf.go                      # é…ç½®ç»“æ„
â”‚   â””â”€â”€ config_dev.yaml              # å¼€å‘é…ç½®
â”œâ”€â”€ biz/
â”‚   â”œâ”€â”€ handler/
â”‚   â”‚   â”œâ”€â”€ user_handler.go          # ç”¨æˆ· CRUD æ¥å£
â”‚   â”‚   â””â”€â”€ recommend_handler.go     # AI æ¨èæ¥å£
â”‚   â””â”€â”€ service/
â”‚       â”œâ”€â”€ user_service.go          # ç”¨æˆ·æœåŠ¡
â”‚       â””â”€â”€ recommend_service.go     # æ¨èæœåŠ¡ï¼ˆå« AIï¼‰
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ agent/
â”‚   â”‚   â”œâ”€â”€ agent.go                 # Eino Agent
â”‚   â”‚   â”œâ”€â”€ tools.go                 # å·¥å…·å®šä¹‰
â”‚   â”‚   â””â”€â”€ retriever.go             # RAG æ£€ç´¢å™¨
â”‚   â””â”€â”€ model/
â”‚       â”œâ”€â”€ user.go                  # æ•°æ®æ¨¡å‹
â”‚       â””â”€â”€ vector.go                # å‘é‡æ¨¡å‹
â”œâ”€â”€ kitex_gen/                       # IDL ç”Ÿæˆä»£ç 
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ docker-compose.yml
â””â”€â”€ README.md
```

#### 12.4.4 æ ¸å¿ƒä»£ç ç¤ºä¾‹

**Agent å®ç°ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰**ï¼š

```go
// internal/agent/agent.go
package agent

import (
    "context"
    "github.com/cloudwego/eino/compose"
    "github.com/cloudwego/eino/components/model"
    "github.com/cloudwego/eino/components/retriever"
    "github.com/cloudwego/eino/flow/agent/react"
    einoModel "github.com/company/user-recommendation/internal/model"
)

type UserRecommendationAgent struct {
    agent     *react.Agent
    retriever retriever.Retriever
}

func NewUserRecommendationAgent(ctx context.Context) (*UserRecommendationAgent, error) {
    // 1. åˆå§‹åŒ– ChatModel
    chatModel, err := einoModel.NewChatModel(ctx, "openai", "gpt-4")
    if err != nil {
        return nil, err
    }

    // 2. åˆå§‹åŒ– Toolsï¼ˆæ•°æ®åº“æŸ¥è¯¢ç­‰ï¼‰
    tools := []tool.Tool{
        NewDatabaseQueryTool(),
        NewUserProfileTool(),
    }
    toolsNode, err := react.NewToolsNode(ctx, tools...)
    if err != nil {
        return nil, err
    }

    // 3. åˆ›å»º ReAct Agent
    agent, err := react.NewAgent(ctx, []react.AgentOption{
        react.WithChatModel(chatModel),
        react.WithTools(toolsNode),
        react.WithMaxLoops(5),
    })

    return &UserRecommendationAgent{
        agent: agent,
    }, nil
}

func (a *UserRecommendationAgent) Recommend(ctx context.Context, userID int, query string) (string, error) {
    // æ„å»ºæ¨èæŸ¥è¯¢
    prompt := fmt.Sprintf("ä¸ºç”¨æˆ· %d æ¨èå†…å®¹ï¼š%s", userID, query)

    // è°ƒç”¨ Agent
    result, err := a.agent.Run(ctx, prompt)
    if err != nil {
        return "", err
    }

    return result, nil
}
```

**æ¨èæœåŠ¡ï¼ˆé›†æˆ Agentï¼‰**ï¼š

```go
// biz/service/recommend_service.go
package service

import (
    "context"
    "github.com/company/user-recommendation/internal/agent"
)

type RecommendService struct {
    ctx   context.Context
    agent *agent.UserRecommendationAgent
}

func NewRecommendService(ctx context.Context, agent *agent.UserRecommendationAgent) *RecommendService {
    return &RecommendService{
        ctx:   ctx,
        agent: agent,
    }
}

func (s *RecommendService) GetRecommendation(ctx context.Context, userID int, query string) (string, error) {
    // ä½¿ç”¨ AI Agent ç”Ÿæˆæ¨è
    return s.agent.Recommend(ctx, userID, query)
}
```

**HTTP Handlerï¼ˆHertz æ¥å£ï¼‰**ï¼š

```go
// biz/handler/recommend_handler.go
package handler

import (
    "context"
    "github.com/cloudwego/hertz/pkg/app"
    "github.com/cloudwego/hertz/pkg/protocol/consts"
)

type RecommendHandler struct {
    service *service.RecommendService
}

func NewRecommendHandler(service *service.RecommendService) *RecommendHandler {
    return &RecommendHandler{service: service}
}

type RecommendRequest struct {
    UserID int    `json:"user_id"`
    Query  string `json:"query"`
}

type RecommendResponse struct {
    Result string `json:"result"`
}

func (h *RecommendHandler) Recommend(ctx context.Context, c *app.RequestContext) {
    var req RecommendRequest
    if err := c.BindAndValidate(&req); err != nil {
        c.JSON(consts.StatusBadRequest, map[string]any{"error": err.Error()})
        return
    }

    // è°ƒç”¨æœåŠ¡ï¼ˆå†…éƒ¨ä½¿ç”¨ AIï¼‰
    result, err := h.service.GetRecommendation(ctx, req.UserID, req.Query)
    if err != nil {
        c.JSON(consts.StatusInternalServerError, map[string]any{"error": err.Error()})
        return
    }

    c.JSON(consts.StatusOK, RecommendResponse{Result: result})
}
```

#### 12.4.5 ä½¿ç”¨æ–¹å¼

```bash
# 1. æ„å»ºé•œåƒ
cd user-recommendation
docker build -t user-recommendation .

# 2. å¯åŠ¨æœåŠ¡
docker-compose up -d

# 3. æµ‹è¯• API
curl -X POST http://localhost:8888/v1/recommend \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": 12345,
    "query": "æ¨èä¸€äº›ç§‘æŠ€æ–°é—»"
  }'

# å“åº”
{
  "result": "æ ¹æ®ç”¨æˆ·ç”»åƒï¼Œä¸ºæ‚¨æ¨èä»¥ä¸‹ç§‘æŠ€æ–°é—»ï¼š..."
}
```

---

### 12.5 é›†æˆè·¯çº¿å›¾

#### é˜¶æ®µ 1ï¼šåŸºç¡€æ”¯æŒï¼ˆ2-3 å‘¨ï¼‰

- [ ] æ‰©å±•é…ç½®ç»“æ„ï¼ˆ`config/server.go`ï¼‰
- [ ] æ·»åŠ å‘½ä»¤è¡Œå‚æ•°ï¼ˆ`cmd/static/server_flags.go`ï¼‰
- [ ] å®ç°åŸºç¡€çš„ Agent ç”Ÿæˆé€»è¾‘
- [ ] åˆ›å»º ReAct Agent æ¨¡æ¿
- [ ] æ–‡æ¡£å’Œç¤ºä¾‹

**äº¤ä»˜ç‰©**ï¼š
```bash
cwgo server -type rpc -service user -enable-eino
```

#### é˜¶æ®µ 2ï¼šåŠŸèƒ½å®Œå–„ï¼ˆ3-4 å‘¨ï¼‰

- [ ] æ”¯æŒ RAG Agent
- [ ] æ”¯æŒ Multi-Agent
- [ ] æ·»åŠ å¸¸ç”¨å·¥å…·æ¨¡æ¿
- [ ] é›†æˆå‘é‡æ•°æ®åº“
- [ ] å®Œå–„é”™è¯¯å¤„ç†

**äº¤ä»˜ç‰©**ï¼š
```bash
cwgo server -type http -service chatbot \
  -enable-eino -agent-type rag -enable-rag
```

#### é˜¶æ®µ 3ï¼šç”Ÿäº§å°±ç»ªï¼ˆ2-3 å‘¨ï¼‰

- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] ç›‘æ§å’Œè¿½è¸ªé›†æˆ
- [ ] é”™è¯¯å¤„ç†å¢å¼º
- [ ] å®‰å…¨åŠ å›º
- [ ] éƒ¨ç½²è‡ªåŠ¨åŒ–

**äº¤ä»˜ç‰©**ï¼š
- å®Œæ•´çš„ CI/CD é…ç½®
- ç”Ÿäº§çº§æ¨¡æ¿
- ç›‘æ§é¢æ¿

---

### 12.6 å…³é”®æŠ€æœ¯è¦ç‚¹

#### 12.6.1 Eino é›†æˆçš„å…³é”®ç‚¹

| æŠ€æœ¯ç‚¹ | è¯´æ˜ | å®ç°å»ºè®® |
|--------|------|---------|
| **Agent ç”Ÿå‘½å‘¨æœŸ** | Agent çš„åˆå§‹åŒ–å’Œé”€æ¯ | åœ¨ main.go ä¸­åˆå§‹åŒ–ï¼Œæ³¨å…¥åˆ° Service |
| **å¹¶å‘å®‰å…¨** | å¤š goroutine è°ƒç”¨ Agent | Eino çš„ Agent æ˜¯å¹¶å‘å®‰å…¨çš„ |
| **é”™è¯¯å¤„ç†** | AI è°ƒç”¨å¤±è´¥çš„å¤„ç† | é™çº§åˆ°ä¼ ç»Ÿé€»è¾‘ï¼Œè¿”å›å‹å¥½é”™è¯¯ |
| **æµå¼å“åº”** | å®æ—¶è¿”å› LLM ç”Ÿæˆå†…å®¹ | æ”¯æŒ SSE æˆ– WebSocket |
| **é…ç½®ç®¡ç†** | API Keyã€æ¨¡å‹é…ç½® | ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼Œé¿å…ç¡¬ç¼–ç  |
| **å¯è§‚æµ‹æ€§** | è¿½è¸ª AI è°ƒç”¨é“¾ | é›†æˆ OpenTelemetry |

#### 12.6.2 å®‰å…¨å»ºè®®

1. **API Key ç®¡ç†**
```yaml
# conf/config_dev.yaml
eino:
  openai:
    api_key: "${OPENAI_API_KEY}"  # âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡
```

2. **è¾“å…¥éªŒè¯**
```go
func (h *Handler) Chat(ctx context.Context, c *app.RequestContext) {
    var req ChatRequest
    if err := c.BindAndValidate(&req); err != nil {
        c.JSON(400, map[string]any{"error": "invalid request"})
        return
    }

    // é™åˆ¶è¾“å…¥é•¿åº¦
    if len(req.Message) > 4000 {
        c.JSON(400, map[string]any{"error": "message too long"})
        return
    }
}
```

3. **æ•æ„Ÿä¿¡æ¯è¿‡æ»¤**
```go
// åœ¨å‘é€åˆ° LLM ä¹‹å‰
func sanitizeInput(input string) string {
    // ç§»é™¤æ‰‹æœºå·ã€é‚®ç®±ç­‰æ•æ„Ÿä¿¡æ¯
    re := regexp.MustCompile(`\d{11}`)
    return re.ReplaceAllString(input, "***")
}
```

---

### 12.7 å‚è€ƒèµ„æº

**Eino å®˜æ–¹èµ„æº**ï¼š
- [Eino GitHub](https://github.com/cloudwego/eino)
- [Eino å®˜æ–¹æ–‡æ¡£](https://www.cloudwego.io/zh/docs/eino/)
- [Eino å¿«é€Ÿå¼€å§‹](https://www.cloudwego.io/zh/docs/eino/quick_start/)

**é›†æˆå¼€å‘å‚è€ƒ**ï¼š
- [ReAct Agent å®ç°](https://github.com/cloudwego/eino/blob/main/flow/agent/react/react.go)
- [RAG åº”ç”¨ç¤ºä¾‹](https://github.com/cloudwego/eino-examples)
- [ç»„ä»¶é›†æˆæ–‡æ¡£](https://www.cloudwego.io/zh/docs/eino/components/overview/)

**å­¦ä¹ èµ„æº**ï¼š
- [LangChain æ¶æ„è®¾è®¡](https://python.langchain.com/docs/expression_language/)ï¼ˆå‚è€ƒï¼‰
- [CloudWeGo ç¤¾åŒº](https://www.cloudwego.io/)

---

### 12.8 å¸¸è§é—®é¢˜

#### Q1: Eino å’Œ LangChain æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**A**:
- Eino æ˜¯ Go è¯­è¨€å®ç°ï¼Œç±»å‹å®‰å…¨ï¼Œæ€§èƒ½æ›´å¥½
- LangChain æ˜¯ Python å®ç°ï¼Œç”Ÿæ€æ›´ä¸°å¯Œ
- Eino æ›´é€‚åˆ Go å¾®æœåŠ¡ç”Ÿæ€ï¼Œä¸ Kitex/Hertz æ— ç¼é›†æˆ

#### Q2: ç”Ÿæˆçš„ä»£ç å¯ä»¥å•†ç”¨å—ï¼Ÿ

**A**: å¯ä»¥ã€‚cwgo å’Œ Eino éƒ½ä½¿ç”¨ Apache 2.0 è®¸å¯è¯ï¼Œå…è®¸å•†ç”¨ã€‚

#### Q3: å¦‚ä½•é€‰æ‹© LLM æä¾›å•†ï¼Ÿ

**A**: æ ¹æ®åœºæ™¯é€‰æ‹©ï¼š
- å›½å†…ç”Ÿäº§ç¯å¢ƒï¼šæ¨è Qwenã€DeepSeek
- å›½é™…ä¸šåŠ¡ï¼šæ¨è OpenAIã€Claude
- ç§æœ‰åŒ–éƒ¨ç½²ï¼šä½¿ç”¨ Ollama + å¼€æºæ¨¡å‹

#### Q4: AI è°ƒç”¨å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

**A**: å®ç°é™çº§æœºåˆ¶ï¼š
```go
func (s *Service) Process(ctx context.Context, query string) (string, error) {
    result, err := s.agent.Run(ctx, query)
    if err != nil {
        // é™çº§åˆ°ä¼ ç»Ÿé€»è¾‘
        return s.fallbackProcess(ctx, query)
    }
    return result, nil
}
```

#### Q5: æ”¯æŒæµå¼å“åº”å—ï¼Ÿ

**A**: æ”¯æŒã€‚Eino å®Œæ•´æ”¯æŒæµå¼å¤„ç†ï¼š
```go
stream, _ := chatModel.Stream(ctx, messages)
for chunk := range stream {
    fmt.Print(chunk)
}
```

---

## æ€»ç»“ï¼ˆæ›´æ–°ï¼‰

æœ¬æ–‡æ¡£è¯¦ç»†åˆ†æäº† cwgo é¡¹ç›®çš„æ¶æ„è®¾è®¡å’Œå®šåˆ¶åŒ–å¼€å‘æ–¹æ³•ï¼Œæ¶µç›–äº†ï¼š

1. **æ•´ä½“æ¶æ„**ï¼šä»ç›®å½•ç»“æ„åˆ°è®¾è®¡åŸåˆ™
2. **ä»£ç ç”Ÿæˆæµç¨‹**ï¼šä»å‘½ä»¤è¾“å…¥åˆ°æ–‡ä»¶è¾“å‡ºçš„å®Œæ•´æµç¨‹
3. **æ ¸å¿ƒæ¨¡å—**ï¼šå„ä¸ªç”Ÿæˆæ¨¡å—çš„è¯¦ç»†è¯´æ˜
4. **æ¨¡æ¿ç³»ç»Ÿ**ï¼šæ¨¡æ¿æ ¼å¼ã€å˜é‡å’Œå‡½æ•°
5. **å®šåˆ¶åŒ–æŒ‡å—**ï¼šä»ç®€å•ä¿®æ”¹åˆ°å®Œå…¨å®šåˆ¶
6. **å®æˆ˜æ¡ˆä¾‹**ï¼šå…·ä½“çš„å®šåˆ¶åŒ–ç¤ºä¾‹
7. **æœ€ä½³å®è·µ**ï¼šå¼€å‘è§„èŒƒå’Œå·¥ä½œæµç¨‹

é€šè¿‡æœ¬æ–‡æ¡£ï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š
- ç†è§£ cwgo çš„ä»£ç ç”ŸæˆåŸç†
- æ‰¾åˆ°éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶
- å®ç°è‡ªå·±çš„å®šåˆ¶åŒ–éœ€æ±‚
- è§£å†³å¸¸è§çš„å¼€å‘é—®é¢˜

å¦‚æœ‰ç–‘é—®æˆ–éœ€è¦è¿›ä¸€æ­¥çš„å¸®åŠ©ï¼Œè¯·å‚è€ƒï¼š
- é¡¹ç›®æºä»£ç 
- å®˜æ–¹æ–‡æ¡£
- ç¤¾åŒºæ”¯æŒ
