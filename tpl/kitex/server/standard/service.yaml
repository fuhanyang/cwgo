path: biz/service/{{SnakeString .ServiceName}}/{{ SnakeString (index .Methods 0).Name }}.go
loop_method: true
update_behavior:
  type: skip
body: |-
  package {{SnakeString .ServiceName}}

  import (
  	"context"
    "errors"

  	{{- range $path, $aliases := ( FilterImports .Imports .Methods )}}
  		{{- if not $aliases }}
  			"{{$path}}"
        {{- else if or (eq $path "github.com/cloudwego/kitex/client") (eq $path "github.com/cloudwego/kitex/pkg/serviceinfo")}}
  		{{- else}}
  			{{- range $alias, $is := $aliases}}
  				{{$alias}} "{{$path}}"
  			{{- end}}
  		{{- end}}
  	{{- end}}
  )

  {{range .Methods}}
  // {{.Name}}Handler defines the function signature for {{.Name}} processor
  type {{.Name}}Handler func(ctx context.Context, {{range .Args}}{{LowerFirst .Name}} {{.Type}}, {{end}}) ({{if not .Void}}{{ .Resp.Type }}, {{end}}error)

  // {{.Name}}Strategies stores the execution strategies for {{.Name}}
  var {{.Name}}Strategies = make(map[string]{{.Name}}Handler)

  type {{.Name}}Service struct {
    ctx context.Context
  }

  {{- if or .ClientStreaming .ServerStreaming}}

  // New{{.Name}}Service new {{.Name}}Service
  func New{{.Name}}Service(ctx context.Context) *{{.Name}}Service {
    return &{{.Name}}Service{ctx: ctx}
  }

  func (s *{{.Name}}Service) Run({{if not .ClientStreaming}}{{range .Args}}{{LowerFirst .Name}} {{.Type}}, {{end}}{{end}}stream {{.PkgRefName}}.{{.ServiceName}}_{{.RawName}}Server) (err error) {
    // Streaming not supported in strategy mode yet
    return
  }
  {{- else}}
  {{- if .Void}}
  {{- if .Oneway}}
  {{- end}}

  // New{{.Name}}Service new {{.Name}}Service
  func New{{.Name}}Service(ctx context.Context) *{{.Name}}Service {
    return &{{.Name}}Service{ctx: ctx}
  }

  // Run calls the registered strategy for {{.Name}}
  func (s *{{.Name}}Service) Run({{range .Args}}{{LowerFirst .Name}} {{.Type}}, {{end}}) error {
    if strategy, ok := {{.Name}}Strategies["default"]; ok {
        return strategy(s.ctx, {{range .Args}}{{LowerFirst .Name}}, {{end}})
    }
    return errors.New("strategy 'default' not found for {{.Name}}")
  }
  {{else}}

  // New{{.Name}}Service new {{.Name}}Service
  func New{{.Name}}Service(ctx context.Context) *{{.Name}}Service {
    return &{{.Name}}Service{ctx: ctx}
  }

  // Run calls the registered strategy for {{.Name}}
  func (s *{{.Name}}Service) Run({{range .Args}}{{LowerFirst .Name}} {{.Type}}, {{end}}) (resp {{.Resp.Type}}, err error) {
    if strategy, ok := {{.Name}}Strategies["default"]; ok {
        return strategy(s.ctx, {{range .Args}}{{LowerFirst .Name}}, {{end}})
    }
    err = errors.New("strategy 'default' not found for {{.Name}}")
    return
  }
  {{end}}
  {{end}}
  {{end}}
